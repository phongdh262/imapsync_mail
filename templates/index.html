<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAP Sync Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- FONTS: Inter for UI, JetBrains Mono for Code/Logs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 4px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.95);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .fade-in-fast {
            animation: fadeIn 0.15s ease-out;
        }

        .pulse-active {
            animation: pulse-slow 2s infinite;
            color: #60a5fa;
        }
    </style>



</head>

<body class="bg-slate-900 min-h-screen text-slate-200 antialiased selection:bg-blue-500 selection:text-white">

    <div class="max-w-[1800px] mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-blue-500/20 rounded-2xl border border-blue-400/30 shadow-lg shadow-blue-500/10">
                    <svg class="w-8 h-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">IMAP Sync Pro</h1>
                    <p class="text-slate-400 text-sm">Batch Migration Tool with Advanced Filters</p>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex items-center gap-4">
                <div class="bg-slate-800 p-1.5 rounded-xl border border-slate-600 inline-flex shadow-lg">
                    <button onclick="switchTab('single')" id="tab-single"
                        class="px-6 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 shadow-md bg-blue-600 text-white shadow-blue-900/20">
                        Single Sync
                    </button>
                    <button onclick="switchTab('bulk')" id="tab-bulk"
                        class="px-6 py-2.5 rounded-lg text-sm font-bold text-slate-400 hover:text-white hover:bg-slate-700 transition-all duration-300">
                        Bulk Sync (CSV)
                    </button>
                </div>
                <button onclick="showGuide()"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 rounded-xl transition-colors shadow-lg group"
                    title="Hướng dẫn sử dụng">
                    <svg class="w-6 h-6 group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </button>

            </div>
        </header>

        <!-- STATS DASHBOARD -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 fade-in">
            <div class="bg-slate-800/80 p-4 rounded-2xl border border-slate-700/50 flex items-center gap-4">
                <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                </div>
                <div>
                    <div class="text-xs text-slate-500 font-bold uppercase tracking-wider">Total Emails</div>
                    <div class="text-xl font-bold text-white font-mono" id="stat_emails">0</div>
                </div>
            </div>
            <div class="bg-slate-800/80 p-4 rounded-2xl border border-slate-700/50 flex items-center gap-4">
                <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="text-xs text-slate-500 font-bold uppercase tracking-wider mb-0.5">Data Transferred</div>
                    <div class="text-xl font-bold text-white font-mono" id="stat_bytes">0 B</div>
                </div>
                <button onclick="resetStats()" title="Reset Stats"
                    class="p-2 rounded-lg bg-slate-900 border border-slate-700 hover:bg-slate-700 text-slate-500 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- MAIN LAYOUT: EVEN SPLIT SCREEN (50/50) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start h-full">

            <!-- LEFT COLUMN: INPUTS -->
            <div class="space-y-6">

                <!-- SINGLE SYNC INPUTS -->
                <div id="input-single" class="fade-in space-y-6">
                    <div class="flex flex-col gap-3 items-stretch relative">
                        <!-- Source Card (Lighter Slate-800) -->
                        <div
                            class="bg-slate-800 rounded-t-3xl rounded-b-xl p-6 shadow-lg border border-slate-600 transition-all hover:border-blue-400/50 group relative z-0">
                            <h2
                                class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-3 uppercase tracking-wider">
                                <span
                                    class="w-6 h-6 rounded-full bg-blue-500/20 text-blue-300 flex items-center justify-center text-xs border border-blue-400/30">1</span>
                                Source
                            </h2>
                            <div class="space-y-3">
                                <input type="text" id="src_host"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 outline-none text-sm transition-all text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Host (e.g. imap.gmail.com)">
                                <input type="text" id="src_user"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Email / User">
                                <div class="relative">
                                    <input type="password" id="src_pass"
                                        class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                        placeholder="Password (App Password for Gmail/Outlook)">
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="relative w-24">
                                        <input type="number" id="src_port" value="993"
                                            class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-blue-400 outline-none text-sm text-center font-mono text-white shadow-inner">
                                    </div>
                                    <label class="flex items-center gap-2 cursor-pointer select-none">
                                        <input type="checkbox" id="src_secure" checked onchange="togglePort('src')"
                                            class="w-4 h-4 rounded border-slate-500 bg-slate-700 text-blue-500 focus:ring-offset-slate-800">
                                        <span class="text-xs font-bold text-slate-400">SSL</span>
                                    </label>
                                    <div class="flex-1"></div>
                                    <button onclick="testConnection('src')"
                                        class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-blue-400 font-bold rounded-lg border border-slate-600 hover:border-blue-400 transition-all text-xs flex items-center gap-1.5 whitespace-nowrap">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        Test Conn
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Pulse Arrow (Visual Connector) -->
                        <div class="flex items-center justify-center -my-6 z-10 relative pointer-events-none">
                            <div
                                class="w-10 h-10 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center shadow-lg">
                                <svg id="syncArrow" class="w-5 h-5 text-slate-400 transition-all duration-500 transform"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </div>
                        </div>

                        <!-- Destination Card (Lighter Slate-800) -->
                        <div
                            class="bg-slate-800 rounded-b-3xl rounded-t-xl p-6 shadow-lg border border-slate-600 transition-all hover:border-indigo-400/50 group relative z-0">
                            <h2
                                class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-3 uppercase tracking-wider">
                                <span
                                    class="w-6 h-6 rounded-full bg-indigo-500/20 text-indigo-300 flex items-center justify-center text-xs border border-indigo-400/30">2</span>
                                Destination
                            </h2>
                            <div class="space-y-3">
                                <input type="text" id="dest_host"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-indigo-400 focus:ring-1 focus:ring-indigo-400 outline-none text-sm transition-all text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Host (e.g. imap.office.com)">
                                <input type="text" id="dest_user"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-indigo-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Email / User">
                                <div class="relative">
                                    <input type="password" id="dest_pass"
                                        class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-indigo-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                        placeholder="Password (App Password)">
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="relative w-24">
                                        <input type="number" id="dest_port" value="993"
                                            class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-indigo-400 outline-none text-sm text-center font-mono text-white shadow-inner">
                                    </div>
                                    <label class="flex items-center gap-2 cursor-pointer select-none">
                                        <input type="checkbox" id="dest_secure" checked onchange="togglePort('dest')"
                                            class="w-4 h-4 rounded border-slate-500 bg-slate-700 text-indigo-500 focus:ring-offset-slate-800">
                                        <span class="text-xs font-bold text-slate-400">SSL</span>
                                    </label>
                                    <div class="flex-1"></div>
                                    <button onclick="testConnection('dest')"
                                        class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-indigo-400 font-bold rounded-lg border border-slate-600 hover:border-indigo-400 transition-all text-xs flex items-center gap-1.5 whitespace-nowrap">
                                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        Test Conn
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="bg-slate-800 p-5 rounded-2xl border border-slate-600 shadow-sm">
                        <button
                            class="flex items-center justify-between w-full text-xs font-bold text-slate-300 hover:text-white transition-colors uppercase tracking-wider mb-2"
                            onclick="document.getElementById('advConfig').classList.toggle('hidden')">
                            <span>Configuration & Filters</span>
                            <div class="bg-slate-700 p-1 rounded-md border border-slate-600">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </button>

                        <div id="advConfig" class="hidden space-y-4 pt-4 border-t border-slate-600 mt-2 fade-in">
                            <div class="flex items-center gap-6">
                                <div class="flex items-center gap-3">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" id="smartMap" checked
                                            class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-500 bg-slate-700 checked:border-blue-500 checked:bg-blue-600 transition-all">
                                        <svg class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100"
                                            viewBox="0 0 14 14" fill="none">
                                            <path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </div>
                                    <label for="smartMap"
                                        class="text-sm font-medium text-slate-300 pointer-events-none">Smart
                                        Map</label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" id="dryRun"
                                            class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-500 bg-slate-700 checked:border-blue-500 checked:bg-blue-600 transition-all">
                                        <svg class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100"
                                            viewBox="0 0 14 14" fill="none">
                                            <path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </div>
                                    <label for="dryRun"
                                        class="text-sm font-medium text-slate-300 pointer-events-none">Dry
                                        Run Mode <span class="text-slate-500 ml-1 text-xs">(Simulate
                                            only)</span></label>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase">Sync
                                    From</label>
                                <input type="date" id="sinceDate"
                                    class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-sm outline-none focus:border-blue-400 text-white shadow-inner">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase">Exclude
                                    Folders</label>
                                <input type="text" id="excludeFolders"
                                    class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-sm outline-none focus:border-blue-400 text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Trash, Spam">
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div
                        class="bg-slate-800 p-6 rounded-3xl shadow-xl border border-slate-600 flex flex-col items-center gap-6">
                        <div class="w-full">
                            <div
                                class="flex justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                                <span>Concurrency Level</span>
                                <span class="text-blue-400 font-mono" id="concurrencyVal">1 Thread</span>
                            </div>
                            <input type="range" id="concurrency" min="1" max="10" value="1"
                                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400">
                        </div>
                        <div class="flex gap-4 w-full">
                            <button id="startSync"
                                class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-2xl shadow-lg shadow-blue-900/40 hover:-translate-y-0.5 transition-all text-sm flex items-center justify-center gap-2 group">
                                Start Migration
                                <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </button>
                            <button id="stopSync"
                                class="hidden flex-1 py-4 bg-slate-700 text-red-500 font-bold rounded-2xl border border-red-900/30 hover:bg-red-900/20 transition-all text-sm">
                                Stop
                            </button>
                        </div>
                    </div>
                </div>



                <!-- BULK SYNC INPUTS -->
                <div id="input-bulk" class="hidden fade-in space-y-6">

                    <!-- Default Configuration (Unified Card) -->
                    <div class="flex flex-col gap-3 items-stretch relative">
                        <!-- Source Default -->
                        <div
                            class="bg-slate-800 rounded-t-3xl rounded-b-xl p-6 shadow-lg border border-slate-600 relative z-0">
                            <h4
                                class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-wider flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Source Default
                            </h4>
                            <div class="grid grid-cols-3 gap-3">
                                <input type="text" id="def_src_host"
                                    class="col-span-2 w-full px-3 py-3 rounded-xl bg-slate-700 border border-slate-600 text-sm focus:border-blue-400 outline-none text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Host (e.g. imap.gmail.com)">
                                <input type="number" id="def_src_port" value="993"
                                    class="w-full px-3 py-3 rounded-xl bg-slate-700 border border-slate-600 text-sm text-center font-mono text-white shadow-inner">
                            </div>
                        </div>

                        <!-- Connector Arrow -->
                        <div class="flex items-center justify-center -my-6 z-10 relative pointer-events-none">
                            <div
                                class="w-8 h-8 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center shadow-lg">
                                <svg class="w-4 h-4 text-slate-500 transform" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </div>
                        </div>

                        <!-- Dest Default -->
                        <div
                            class="bg-slate-800 rounded-b-3xl rounded-t-xl p-6 shadow-lg border border-slate-600 relative z-0">
                            <h4
                                class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-wider flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span> Destination Default
                            </h4>
                            <div class="grid grid-cols-3 gap-3">
                                <input type="text" id="def_dest_host"
                                    class="col-span-2 w-full px-3 py-3 rounded-xl bg-slate-700 border border-slate-600 text-sm focus:border-indigo-400 outline-none text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Host (e.g. imap.office.com)">
                                <input type="number" id="def_dest_port" value="993"
                                    class="w-full px-3 py-3 rounded-xl bg-slate-700 border border-slate-600 text-sm text-center font-mono text-white shadow-inner">
                            </div>
                        </div>
                    </div>

                    <!-- Bulk CSV Input -->
                    <div class="bg-slate-800 rounded-3xl p-6 shadow-xl border border-slate-600 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-sm font-bold text-slate-300 uppercase tracking-wider">CSV Data Payload
                            </div>
                            <label
                                class="cursor-pointer text-xs font-bold text-blue-400 bg-blue-500/10 border border-blue-500/20 px-3 py-1.5 rounded-lg hover:bg-blue-500/20 transition-colors">
                                <input type="file" id="csvFile" accept=".csv" class="hidden"> Upload File
                            </label>
                        </div>
                        <textarea id="bulkInput" rows="10"
                            class="w-full p-4 rounded-xl bg-slate-700 text-slate-300 font-mono text-xs border border-slate-600 leading-normal focus:border-blue-400 outline-none resize-none shadow-inner"
                            placeholder="user1,pass1,user1_new,pass2"></textarea>

                        <!-- Bulk Advanced -->
                        <div class="mt-6 pt-6 border-t border-slate-600">
                            <button
                                class="flex items-center justify-between w-full text-xs font-bold text-slate-400 hover:text-white transition-colors mb-2 uppercase tracking-wider"
                                onclick="document.getElementById('bulkAdvConfig').classList.toggle('hidden')">
                                <span>Advanced Options</span>
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="bulkAdvConfig" class="hidden grid grid-cols-2 gap-4 mt-4 fade-in">
                                <div class="col-span-2 flex items-center gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer select-none">
                                        <input type="checkbox" id="bulkSmartMap" checked
                                            class="w-4 h-4 rounded border-slate-500 bg-slate-700 text-blue-600">
                                        <span class="text-xs font-bold text-slate-400">Smart Map</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer select-none">
                                        <input type="checkbox" id="bulkDryRun"
                                            class="w-4 h-4 rounded border-slate-500 bg-slate-700 text-blue-600">
                                        <span class="text-xs font-bold text-slate-400">Dry Run</span>
                                    </label>
                                </div>
                                <input type="date" id="bulkSinceDate"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 text-xs text-slate-400 outline-none shadow-inner">
                                <input type="text" id="bulkExcludeFolders"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 text-xs outline-none text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Exclude (e.g. Trash, Spam)">
                                <textarea id="folderMapping" rows="3"
                                    class="col-span-2 w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 text-xs outline-none text-white placeholder-slate-400 shadow-inner font-mono"
                                    placeholder="Folder Mapping (Source:Dest)&#10;Sent:Sent Items"></textarea>
                            </div>
                        </div>

                        <!-- Bulk Controls -->
                        <div class="mt-6 flex flex-col gap-3">
                            <div
                                class="flex items-center justify-between bg-slate-900/50 px-4 py-3 rounded-xl border border-slate-700">
                                <span class="text-xs font-bold text-slate-500 uppercase">Batch Concurrency</span>
                                <input type="number" id="batchConcurrency" value="3" min="1" max="5"
                                    class="w-12 bg-slate-800 border border-slate-600 rounded text-center text-sm font-bold outline-none text-white focus:border-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="parseAndLoad()"
                                    class="py-4 bg-slate-700 border border-slate-600 text-slate-300 font-bold rounded-xl hover:bg-slate-600 hover:text-white transition-all text-xs uppercase tracking-wider">Preview
                                    Jobs</button>
                                <button onclick="startBatch()" id="btnStartBatch"
                                    class="py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition-all text-xs uppercase tracking-wider disabled:opacity-50"
                                    disabled>Start Batch</button>
                                <button onclick="stopBatch()" id="btnStopBatch"
                                    class="hidden col-span-2 py-4 bg-red-500/10 text-red-500 font-bold rounded-xl border border-red-500/20 hover:bg-red-500/20">Stop
                                    All</button>
                                <button onclick="retryFailed()" id="btnRetryFailed"
                                    class="hidden col-span-2 py-4 bg-yellow-500/10 text-yellow-500 font-bold rounded-xl border border-yellow-500/20 hover:bg-yellow-500/20 transition-all">Retry
                                    Failed Jobs ↻</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- RIGHT COLUMN: OUTPUTS -->
            <div class="space-y-6 h-full min-h-[600px] lg:min-h-0 lg:h-[calc(100vh-8rem)] sticky top-6">

                <!-- SINGLE OUTPUT -->
                <div id="output-single" class="fade-in h-full flex flex-col">
                    <div
                        class="bg-slate-800 rounded-3xl overflow-hidden shadow-2xl border border-slate-600 flex flex-col h-full ring-1 ring-white/5">
                        <div
                            class="px-5 py-4 bg-slate-900/50 border-b border-slate-600 flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Terminal
                                    Output</span>
                            </div>
                            <div class="flex gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/30"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/30">
                                </div>
                                <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/30">
                                </div>
                            </div>
                        </div>
                        <!-- WARNING MESSAGE (SINGLE SYNC) -->
                        <div class="px-6 py-3 bg-amber-500/10 border-b border-amber-500/20 flex items-start gap-3">
                            <div class="shrink-0 mt-0.5">
                                <svg class="w-5 h-5 text-amber-500" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <div class="text-xs text-amber-200/80 font-medium leading-relaxed">
                                <strong class="text-amber-400">Không đóng tab trình duyệt:</strong> Mặc dù hệ thống có
                                cơ chế
                                khôi phục, nhưng để ổn định nhất, hãy giữ tab trình duyệt mở khi đang chạy Batch lớn.
                            </div>
                        </div>
                        <div id="logs"
                            class="p-6 overflow-y-auto font-mono text-xs md:text-sm text-slate-300 leading-relaxed scroll-smooth flex-1 bg-slate-900/80 shadow-inner">
                            <div class="text-slate-500 italic select-none">Waiting for process start...</div>
                        </div>
                    </div>
                </div>

                <!-- BULK OUTPUT -->
                <div id="output-bulk" class="hidden fade-in h-full">
                    <div
                        class="bg-slate-800 rounded-3xl shadow-xl border border-slate-600 overflow-hidden flex flex-col h-full ring-1 ring-white/5">
                        <div
                            class="px-6 py-4 border-b border-slate-600 bg-slate-900/30 flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-slate-300 text-sm">Active Job Queue</h3>
                            <button onclick="downloadReport()"
                                class="text-xs font-bold text-emerald-500 hover:text-emerald-400 flex items-center gap-1.5 bg-emerald-500/10 px-3 py-1.5 rounded-lg border border-emerald-500/20 transition-colors">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Export Report
                            </button>
                        </div>
                        <!-- WARNING MESSAGE -->
                        <div class="px-6 py-3 bg-amber-500/10 border-b border-amber-500/20 flex items-start gap-3">
                            <div class="shrink-0 mt-0.5">
                                <svg class="w-5 h-5 text-amber-500" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <div class="text-xs text-amber-200/80 font-medium leading-relaxed">
                                <strong class="text-amber-400">Không đóng tab trình duyệt:</strong> Mặc dù hệ thống có
                                cơ chế
                                khôi phục, nhưng để ổn định nhất, hãy giữ tab trình duyệt mở khi đang chạy Batch lớn.
                            </div>
                        </div>
                        <div id="jobsContainer" class="hidden flex-1 flex flex-col overflow-hidden">
                            <div class="overflow-y-auto flex-1">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr
                                            class="bg-slate-900/50 border-b border-slate-600 text-[10px] text-slate-500 uppercase font-bold tracking-wider sticky top-0 backdrop-blur-md">
                                            <th class="px-6 py-3">Migration Context</th>
                                            <th class="px-6 py-3">Status</th>
                                            <th class="px-6 py-3 w-1/4">Progress</th>
                                            <th class="px-6 py-3 text-right">Controls</th>
                                        </tr>
                                    </thead>
                                    <tbody id="jobsTableBody" class="divide-y divide-slate-600 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="jobsPlaceholder"
                            class="flex-1 flex flex-col items-center justify-center p-10 text-slate-500">
                            <div class="bg-slate-900/50 p-6 rounded-full mb-4">
                                <svg class="w-12 h-12 text-slate-600" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                            </div>
                            <p class="text-sm font-medium">No jobs queued. Load a CSV to begin.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>



    <!-- LOG MODAL -->
    <div id="logModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[80vh] overflow-hidden border border-slate-600 fade-in">
                <div class="px-6 py-4 border-b border-slate-600 flex justify-between items-center bg-slate-900/50">
                    <h3 class="font-bold text-slate-200" id="modalTitle">Logs</h3>
                    <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">✕</button>
                </div>
                <div id="modalLogContent"
                    class="flex-1 overflow-y-auto bg-slate-900 p-6 font-mono text-xs text-slate-300"></div>
            </div>
        </div>
    </div>

    <!-- CONFIRM CUSTOM MODAL -->
    <div id="confirmModal" class="fixed inset-0 z-[60] hidden">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeConfirm(false)">
        </div>
        <div class="fixed inset-0 z-[70] flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-600 fade-in-fast flex flex-col overflow-hidden ring-1 ring-white/10">
                <div class="p-6 text-center">
                    <div
                        class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                        <svg class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2" id="confirmTitle">Confirm Action</h3>
                    <p class="text-sm text-slate-400 leading-relaxed" id="confirmMsg">Are you sure you want to
                        proceed?
                    </p>
                </div>
                <div class="flex border-t border-slate-700">
                    <button onclick="closeConfirm(false)"
                        class="flex-1 py-4 text-sm font-bold text-slate-400 hover:bg-slate-700/50 hover:text-white transition-colors">Cancel</button>
                    <div class="w-px bg-slate-700"></div>
                    <button onclick="closeConfirm(true)"
                        class="flex-1 py-4 text-sm font-bold text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INFO CUSTOM MODAL (NEW) -->
    <div id="infoModal" class="fixed inset-0 z-[60] hidden">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeInfo()"></div>
        <div class="fixed inset-0 z-[70] flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-600 fade-in-fast flex flex-col overflow-hidden ring-1 ring-white/10">
                <div class="p-6 text-center">
                    <div
                        class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/20">
                        <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2" id="infoTitle">Notification</h3>
                    <p class="text-sm text-slate-400 leading-relaxed" id="infoMsg">Message</p>
                </div>
                <div class="flex border-t border-slate-700">
                    <button onclick="closeInfo()"
                        class="flex-1 py-4 text-sm font-bold text-blue-400 hover:bg-slate-700/50 transition-colors">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UTILS ---
        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0; return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });

        function formatIMAPDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${d.getDate()}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        // --- TABS & UI ---
        document.getElementById('csvFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) { document.getElementById('bulkInput').value = e.target.result; };
            reader.readAsText(file);
        });

        function switchTab(tab) {
            // Hide all first
            ['input-single', 'input-bulk', 'output-single', 'output-bulk'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            const sBtn = document.getElementById('tab-single');
            const bBtn = document.getElementById('tab-bulk');

            const activeClass = "px-6 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 shadow-md bg-blue-600 text-white shadow-blue-900/20";
            const inactiveClass = "px-6 py-2.5 rounded-lg text-sm font-bold text-slate-400 hover:text-white hover:bg-slate-700 transition-all duration-300";

            if (tab === 'single') {
                document.getElementById('input-single').classList.remove('hidden');
                document.getElementById('output-single').classList.remove('hidden');
                sBtn.className = activeClass;
                bBtn.className = inactiveClass;
            } else {
                document.getElementById('input-bulk').classList.remove('hidden');
                document.getElementById('output-bulk').classList.remove('hidden');
                bBtn.className = activeClass;
                sBtn.className = inactiveClass;
            }
        }

        // --- SINGLE SYNC ---
        const startBtn = document.getElementById('startSync');
        const stopBtn = document.getElementById('stopSync');
        const logsDiv = document.getElementById('logs');
        const concurrencyInput = document.getElementById('concurrency');
        let currentSyncId = null;

        concurrencyInput.addEventListener('input', (e) => {
            document.getElementById('concurrencyVal').textContent = `${e.target.value} Thread${e.target.value > 1 ? 's' : ''}`;
        });

        function appendLog(msg, isError = false) {
            // Remove placeholder
            if (logsDiv.querySelector('.italic')) logsDiv.innerHTML = '';

            const div = document.createElement('div');
            let content = msg;

            // Simple Syntax Highlighting
            if (!isError) {
                if (msg.includes('Synced')) content = `<span class="text-blue-400 font-bold">Synced</span> ${msg.replace('Synced', '').replace('->', '<span class="text-slate-500">-></span>')}`;
                else if (msg.includes('Mapping')) content = `<span class="text-purple-400 font-bold">Mapping</span> ${msg.replace('Mapping', '')}`;
                else if (msg.includes('Connecting')) content = `<span class="text-yellow-400 font-bold">Connecting</span> ${msg.replace('Connecting', '')}`;
                else if (msg.includes('Completed') || msg.includes('Success')) content = `<span class="text-green-400 font-bold">✓</span> <span class="text-green-300">${msg}</span>`;
            }

            div.className = isError
                ? 'text-red-400 mb-1 border-l-2 border-red-500/50 pl-2 font-mono text-xs'
                : 'mb-1 border-l-2 border-slate-700 pl-2 font-mono text-xs text-slate-300 hover:bg-slate-800/30 transition-colors';

            div.innerHTML = content;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function downloadLog() {
            const text = logsDiv.innerText;
            if (!text) { showInfo("No Logs", "Terminal is empty.", true); return; }
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `imap-sync-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.log`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }


        function parseFolderMapping() {
            const raw = document.getElementById('folderMapping').value;
            if (!raw.trim()) return {};
            const mapping = {};
            raw.split('\n').forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const src = parts[0].trim();
                    const dest = parts.slice(1).join(':').trim(); // Handle dest containing colons
                    if (src && dest) mapping[src] = dest;
                }
            });
            return mapping;
        }

        startBtn.addEventListener('click', async () => {
            try {
                console.log("Start Button Clicked");
                // Verify Critical Elements exist
                if (!document.getElementById('syncArrow')) throw new Error("Missing UI Element: syncArrow");
                if (!document.getElementById('folderMapping')) console.warn("Missing Bulk Mapping (Non-fatal)");

                const folderMap = parseFolderMapping();
                const data = {
                    src_host: document.getElementById('src_host').value,
                    src_port: document.getElementById('src_port').value,
                    src_user: document.getElementById('src_user').value,
                    src_pass: document.getElementById('src_pass').value,
                    src_secure: document.getElementById('src_secure').checked,
                    dest_host: document.getElementById('dest_host').value,
                    dest_port: document.getElementById('dest_port').value,
                    dest_user: document.getElementById('dest_user').value,
                    dest_pass: document.getElementById('dest_pass').value,
                    dest_secure: document.getElementById('dest_secure').checked,
                    concurrency: concurrencyInput.value,
                    sync_id: generateUUID(),
                    // NEW ADVANCED PARAMS
                    dry_run: document.getElementById('dryRun').checked,
                    smart_map: document.getElementById('smartMap').checked,
                    since_date: formatIMAPDate(document.getElementById('sinceDate').value),
                    exclude_folders: document.getElementById('excludeFolders').value,
                    folder_mapping: folderMap
                };
                currentSyncId = data.sync_id;

                if (!data.src_host || !data.src_user || !data.src_pass) { showInfo("Configuration Error", "Please fill in all required Source and Destination fields."); return; }

                // Save session
                localStorage.setItem('active_sync_id', currentSyncId);
                localStorage.setItem('active_sync_config', JSON.stringify(data));

                startBtn.disabled = true; startBtn.style.opacity = '0.5';
                stopBtn.classList.remove('hidden');
                logsDiv.innerHTML = ''; // Clear logs

                if (Object.keys(folderMap).length > 0) {
                    appendLog(`>>> Folder Mapping Configured: ${Object.keys(folderMap).length} rules.`, false);
                }
                if (data.dry_run) appendLog(">>> DRY RUN MODE: No data will be transferred.", false);
                appendLog("Connecting... (Waiting for Server Response)", false);

                document.getElementById('syncArrow').classList.add('pulse-active');

                // DEBUG: Trace execution
                console.log("Sending request to /api/sync", data);
                // appendLog(`[DEBUG] Sending Request: ${data.sync_id}`, false);



                await runSyncStream(data, (msg, isErr) => {
                    appendLog(msg, isErr);

                    // Client-side Stat Counting (Approximation)
                    if (msg.includes('Synced')) {
                        let count = parseInt(document.getElementById('stat_emails').textContent.replace(/,/g, '')) || 0;
                        document.getElementById('stat_emails').textContent = (count + 1).toLocaleString();
                    }
                    if (msg === 'Sync completed!') {
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 },
                            colors: ['#60a5fa', '#34d399', '#f472b6']
                        });
                    }
                }, () => { });

                document.getElementById('syncArrow').classList.remove('pulse-active');
                startBtn.disabled = false; startBtn.style.opacity = '1';
                stopBtn.classList.add('hidden');

            } catch (err) {
                console.error(err);
                alert("Start Error: " + err.message);
                startBtn.disabled = false; startBtn.style.opacity = '1';
            }
        });

        stopBtn.addEventListener('click', async () => {
            if (currentSyncId) {
                await fetch('/api/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sync_id: currentSyncId }) });
                localStorage.removeItem('active_sync_id');
                // localStorage.removeItem('active_sync_config'); // Keep config for ease
            }
        });

        async function runSyncStream(data, logCtx, progCtx) {
            try {
                const response = await fetch('/api/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const lines = decoder.decode(value).split('\n\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const p = JSON.parse(line.replace('data: ', ''));
                                logCtx(p.message, p.is_error);
                                if (p.progress !== undefined) progCtx(p.progress);

                                if (p.message === 'Sync completed!' || p.message === 'Stopped by user.') {
                                    localStorage.removeItem('active_sync_id');
                                }
                            } catch (e) { }
                        }
                    });
                }
            } catch (err) { logCtx("Network Error: " + err, true); }
        }

        // --- BULK SYNC ---
        let bulkJobs = [];
        let isBatchRunning = false;
        let shouldStopBatch = false; // Flag for Stop All
        let currentViewedJobId = null;

        function inferHost(email) {
            if (!email) return 'imap.gmail.com';
            if (email.includes('@gmail')) return 'imap.gmail.com';
            if (email.includes('@outlook') || email.includes('@office')) return 'outlook.office365.com';
            const parts = email.split('@');
            return parts.length > 1 ? `imap.${parts[1]}` : 'imap.gmail.com';
        }

        function parseCSVLine(str) {
            const arr = []; let quote = false; let col = '';
            for (let c of str) {
                if (c === '"') { quote = !quote; continue; }
                if (c === ',' && !quote) { arr.push(col); col = ''; continue; }
                col += c;
            }
            arr.push(col); return arr.map(s => s.trim());
        }

        function parseAndLoad() {
            const text = document.getElementById('bulkInput').value.trim();
            const defSrcHost = document.getElementById('def_src_host').value.trim();
            const defDestHost = document.getElementById('def_dest_host').value.trim();

            bulkJobs = [];
            text.split('\n').forEach(line => {
                if (!line.trim() || line.trim().startsWith('#')) return;
                const p = parseCSVLine(line.trim());
                let job = { status: 'Pending', progress: 0, id: generateUUID(), fullLogs: [] };

                if (p.length >= 8) {
                    Object.assign(job, {
                        src_host: p[0], src_port: p[1], src_user: p[2], src_pass: p[3],
                        src_secure: (p[1] == '993'),
                        dest_host: p[4], dest_port: p[5], dest_user: p[6], dest_pass: p[7],
                        dest_secure: (p[5] == '993')
                    });
                } else if (p.length >= 4) {
                    Object.assign(job, {
                        src_host: defSrcHost || inferHost(p[0]), src_port: '993', src_user: p[0], src_pass: p[1], src_secure: true,
                        dest_host: defDestHost || inferHost(p[2]), dest_port: '993', dest_user: p[2], dest_pass: p[3], dest_secure: true
                    });
                } else return;
                bulkJobs.push(job);
            });

            if (bulkJobs.length > 0) {
                renderJobs();
                document.getElementById('jobsContainer').classList.remove('hidden');
                document.getElementById('jobsPlaceholder').classList.add('hidden'); // Hide placeholder
                document.getElementById('btnStartBatch').disabled = false;
            }
        }

        function renderJobs() {
            const tbody = document.getElementById('jobsTableBody');
            tbody.innerHTML = '';
            bulkJobs.forEach((job) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-900 transition-colors group border-b border-slate-600";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex flex-col gap-1">
                             <div class="font-bold text-slate-300 break-all" title="${job.src_user}">${job.src_user}</div>
                             <div class="text-[10px] text-slate-500 uppercase tracking-wide">to</div>
                             <div class="font-bold text-slate-300 break-all" title="${job.dest_user}">${job.dest_user}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span id="status-${job.id}" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400 border border-slate-600 mb-1">${job.status}</span>
                        <div id="lastlog-${job.id}" class="text-[10px] text-slate-500 truncate w-32 cursor-pointer hover:text-blue-400 transition-colors" onclick="viewLogs('${job.id}')">${job.lastLog || 'Waiting...'}</div>
                    </td>
                    <td class="px-6 py-4">
                         <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden mb-2 border border-slate-600"><div id="prog-${job.id}" class="bg-blue-600 h-full rounded-full transition-all" style="width: ${job.progress}%"></div></div>
                    </td>
                    <td class="px-6 py-4 text-right">
                         <button onclick="viewLogs('${job.id}')" class="text-xs font-bold text-slate-500 hover:text-blue-400 mr-3 transition-colors">LOGS</button>
                         <button onclick="stopJob('${job.id}')" class="text-xs font-bold text-red-400 hover:text-red-300 transition-colors ${job.status !== 'Running' ? 'hidden' : ''}" id="stop-${job.id}">STOP</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveBatchState() {
            localStorage.setItem('active_batch_jobs', JSON.stringify(bulkJobs));
            localStorage.setItem('is_batch_running', isBatchRunning);
        }

        async function startBatch() {
            if (isBatchRunning) return; isBatchRunning = true; shouldStopBatch = false;
            document.getElementById('btnStartBatch').disabled = true;
            document.getElementById('btnStopBatch').classList.remove('hidden');

            saveBatchState(); // Save initial state

            // CAPTURE BULK SETTINGS ONLY ONCE AT START
            const bulkSettings = {
                dry_run: document.getElementById('bulkDryRun').checked,
                smart_map: document.getElementById('bulkSmartMap').checked,
                since_date: formatIMAPDate(document.getElementById('bulkSinceDate').value),
                exclude_folders: document.getElementById('bulkExcludeFolders').value,
                folder_mapping: parseFolderMapping()
            };

            const batchConcurrent = parseInt(document.getElementById('batchConcurrency').value) || 2;
            let idx = 0, active = 0;

            const runNext = async () => {
                if (shouldStopBatch) {
                    if (active === 0) cleanupBatch();
                    return;
                }

                // Skip already Done/Error (for resume support)
                while (idx < bulkJobs.length && (bulkJobs[idx].status === 'Done' || bulkJobs[idx].status === 'Error' || bulkJobs[idx].status === 'Stopped')) {
                    idx++;
                }

                if (idx >= bulkJobs.length) {
                    if (active === 0) cleanupBatch();
                    return;
                }
                const jobIdx = idx++; active++;
                const job = bulkJobs[jobIdx];

                job.status = 'Running';
                saveBatchState();

                const stEl = document.getElementById(`status-${job.id}`);
                if (stEl) { stEl.textContent = 'Running'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-500/30 mb-1"; }
                document.getElementById(`stop-${job.id}`).classList.remove('hidden');

                // Get concurrency from slider (default 2 if not found)
                const threadConcurrency = parseInt(document.getElementById('concurrency').value) || 2;
                // MERGE JOB DATA WITH ADV MODES
                const jobData = { ...job, concurrency: threadConcurrency, sync_id: job.id, ...bulkSettings };

                await runSyncStream(jobData,
                    (msg, isErr) => {
                        if (job.status === 'Stopped') return; // Ignore logs if stopped

                        job.lastLog = msg; job.fullLogs.push({ msg, isError: isErr });
                        const logEl = document.getElementById(`lastlog-${job.id}`);
                        if (logEl) logEl.textContent = msg;

                        const modal = document.getElementById('logModal');
                        if (!modal.classList.contains('hidden') && currentViewedJobId === job.id) {
                            const el = document.getElementById('modalLogContent');
                            const d = document.createElement('div'); d.className = isErr ? "text-red-400 mb-1" : "text-slate-300 mb-1"; d.textContent = msg;
                            el.appendChild(d); el.scrollTop = el.scrollHeight;
                        }

                        // Only mark as Failed if strictly Critical
                        if (isErr && msg.includes('Critical Error')) {
                            job.status = 'Error';
                            saveBatchState();
                            if (stEl) { stEl.textContent = 'Failed'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-red-900/30 text-red-400 border border-red-500/30 mb-1"; }
                        }
                    },
                    (prog) => {
                        if (job.status === 'Stopped') return;

                        job.progress = prog;
                        const progEl = document.getElementById(`prog-${job.id}`);
                        if (progEl) progEl.style.width = prog + '%';
                        if (prog === 100) {
                            job.status = 'Done';
                            saveBatchState();
                            if (stEl) { stEl.textContent = 'Done'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 mb-1"; }
                            document.getElementById(`stop-${job.id}`).classList.add('hidden');
                        }
                    }
                );

                active--;
                if (shouldStopBatch) {
                    // Check again if we should stop
                    if (active === 0) cleanupBatch();
                } else {
                    runNext();
                }
            };

            for (let i = 0; i < batchConcurrent; i++) runNext();
        }

        function cleanupBatch() {
            isBatchRunning = false;
            document.getElementById('btnStartBatch').disabled = false;
            document.getElementById('btnStopBatch').classList.add('hidden');
            if (shouldStopBatch) showInfo("Batch Stopped", "Batch processing has been stopped."); else showInfo("Batch Completed", "All jobs in the queue have been processed.");

            // Check if all really done to clear
            const allDone = bulkJobs.every(j => j.status === 'Done' || j.status === 'Error' || j.status === 'Stopped');
            if (allDone) {
                localStorage.removeItem('active_batch_jobs');
                localStorage.removeItem('is_batch_running');
            }
        }

        // --- CUSTOM CONFIRM MODAL LOGIC ---
        let confirmResolve = null;
        function showConfirm(title, msg) {
            return new Promise((resolve) => {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMsg').textContent = msg;
                document.getElementById('confirmModal').classList.remove('hidden');
                confirmResolve = resolve;
            });
        }
        function closeConfirm(result) {
            document.getElementById('confirmModal').classList.add('hidden');
            if (confirmResolve) confirmResolve(result);
            confirmResolve = null;
        }

        async function stopBatch() {
            const ok = await showConfirm("Stop All Jobs?", "Are you sure you want to stop all running tasks? This action cannot be undone.");
            if (!ok) return;

            shouldStopBatch = true; // Prevent new jobs

            // Stop all currently running jobs
            const activeJobIds = bulkJobs.filter(j => j.status === 'Running' || j.status === 'Restoring').map(j => j.id);
            for (let id of activeJobIds) {
                stopJob(id, false); // false = don't confirm for each
            }
        }

        // --- REPORT & MODAL ---
        function downloadReport() {
            if (!bulkJobs.length) return showInfo("No Data", "There are no jobs to export.");
            const header = ["Source", "Dest", "Status", "Last Log"];
            const rows = bulkJobs.map(j => [j.src_user, j.dest_user, j.status, `"${j.lastLog}"`]);
            const csv = "data:text/csv;charset=utf-8," + header.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "report.csv";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function viewLogs(id) {
            const job = bulkJobs.find(j => j.id === id); if (!job) return;
            currentViewedJobId = id;
            document.getElementById('modalTitle').textContent = `Logs: ${job.src_user}`;
            const el = document.getElementById('modalLogContent');
            el.innerHTML = job.fullLogs.map(l => `<div class="${l.isError ? 'text-red-400' : 'text-slate-300'} mb-1">${l.msg}</div>`).join('');
            document.getElementById('logModal').classList.remove('hidden');
            el.scrollTop = el.scrollHeight;
        }
        function closeModal() { document.getElementById('logModal').classList.add('hidden'); currentViewedJobId = null; }

        // --- INFO MODAL LOGIC ---
        function showInfo(title, msg) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoMsg').textContent = msg;
            document.getElementById('infoModal').classList.remove('hidden');
        }
        function closeInfo() {
            document.getElementById('infoModal').classList.add('hidden');
        }

        async function stopJob(id, ask = true) {
            if (ask) {
                const ok = await showConfirm("Stop Job?", "Are you sure you want to stop this migration task?");
                if (!ok) return;
            }
            try {
                await fetch('/api/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sync_id: id }) });
                // Mark as Stopped in UI immediately 
                const job = bulkJobs.find(j => j.id === id);
                if (job) {
                    job.status = 'Stopped';
                    job.lastLog = 'Stopped by user';
                    const stEl = document.getElementById(`status-${id}`);
                    if (stEl) { stEl.textContent = 'Stopped'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400 border border-slate-600 mb-1"; }
                    document.getElementById(`stop-${id}`).classList.add('hidden');
                }
            } catch (e) { }
        }
    </script>
    <script>
        // ... (pollJobStatus, restoreSession, pollLogs remain essentially the same, just ensuring no loose alerts)
        async function pollJobStatus(job) {
            const sid = job.id;
            let lastLogCount = 0;
            const poll = async () => {
                if (job.status !== 'Running' && job.status !== 'Restoring') return;
                try {
                    const res = await fetch(`/api/status/${sid}`);
                    const st = await res.json();

                    const logRes = await fetch(`/api/logs/${sid}`);
                    if (logRes.ok) {
                        const logs = await logRes.json();
                        if (logs.length > lastLogCount) {
                            const newLogs = logs.slice(lastLogCount);
                            newLogs.forEach(l => {
                                job.lastLog = l.message;
                                job.fullLogs.push({ msg: l.message, isError: l.is_error });
                            });
                            lastLogCount = logs.length;

                            const logEl = document.getElementById(`lastlog-${job.id}`);
                            if (logEl) logEl.textContent = job.lastLog;
                            const lastProg = logs[logs.length - 1].progress;
                            if (lastProg !== undefined) {
                                job.progress = lastProg;
                                const progEl = document.getElementById(`prog-${job.id}`);
                                if (progEl) progEl.style.width = lastProg + '%';
                            }
                        }
                    }

                    if (!st.active) {
                        job.status = 'Done';
                        const hasError = job.fullLogs.some(l => l.isError && l.msg.includes('Critical'));
                        if (hasError) job.status = 'Error';

                        const stEl = document.getElementById(`status-${job.id}`);
                        if (stEl) {
                            stEl.textContent = job.status;
                            // Dark Mode Badges
                            if (job.status === 'Error') stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-red-900/30 text-red-400 border border-red-500/30 mb-1";
                            else stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 mb-1";
                        }
                        // document.getElementById(`stop-${job.id}`).classList.add('hidden');
                        saveBatchState();
                        return; // End poll
                    }
                    setTimeout(poll, 3000);
                } catch (e) { setTimeout(poll, 5000); }
            };
            poll();
        }

        // --- SESSION RECOVERY ---
        async function restoreSession() {
            // 1. Check Single Sync (Legacy)
            const sid = localStorage.getItem('active_sync_id');
            if (sid) {
                // Try restore single sync logic
                try {
                    const res = await fetch(`/api/status/${sid}`);
                    const status = await res.json();
                    if (status.active) {
                        // Restore UI for Single Sync
                        const config = JSON.parse(localStorage.getItem('active_sync_config') || '{}');
                        if (config.src_host) document.getElementById('src_host').value = config.src_host;
                        if (config.dest_host) document.getElementById('dest_host').value = config.dest_host;
                        currentSyncId = sid;

                        // Enable Single Tab
                        switchTab('single');
                        startBtn.disabled = true; startBtn.style.opacity = '0.5';
                        stopBtn.classList.remove('hidden');
                        logsDiv.innerHTML = '';
                        appendLog(">>> Restoring session connection...", false);
                        pollLogs(sid);
                    } else { localStorage.removeItem('active_sync_id'); }
                } catch (e) { }
            }

            // 2. Check Bulk Sync
            const savedBatch = localStorage.getItem('active_batch_jobs');
            if (savedBatch) {
                try {
                    bulkJobs = JSON.parse(savedBatch);
                    if (bulkJobs.length > 0) {
                        switchTab('bulk');
                        renderJobs();
                        document.getElementById('jobsContainer').classList.remove('hidden');
                        document.getElementById('jobsPlaceholder').classList.add('hidden');

                        // Assume running/paused if saved
                        if (localStorage.getItem('is_batch_running') === 'true') {
                            document.getElementById('btnStartBatch').disabled = true;
                            document.getElementById('btnStopBatch').classList.remove('hidden');
                            isBatchRunning = true;
                        }

                        let runningCount = 0;
                        bulkJobs.forEach(job => {
                            if (job.status === 'Running') {
                                job.status = 'Restoring';
                                pollJobStatus(job);
                                runningCount++;
                            }
                        });

                        // Restart worker if needed (pending jobs exist)
                        const hasPending = bulkJobs.some(j => j.status === 'Pending');
                        if (hasPending && isBatchRunning) {
                            isBatchRunning = false;
                            startBatch();
                        } else if (runningCount === 0 && !hasPending) {
                            cleanupBatch();
                        }
                    }
                } catch (e) { console.error("Batch restore error", e); }
            }
        }

        async function pollLogs(sid) {
            let lastLogCount = 0;
            const poll = async () => {
                if (!currentSyncId) return; // Stopped
                try {
                    const res = await fetch(`/api/status/${sid}`);
                    const st = await res.json();

                    const logRes = await fetch(`/api/logs/${sid}`);
                    if (logRes.ok) {
                        const logs = await logRes.json();
                        // Append new logs
                        if (logs.length > lastLogCount) {
                            const newLogs = logs.slice(lastLogCount);
                            newLogs.forEach(l => appendLog(l.message, l.is_error || l.i_error));
                            lastLogCount = logs.length;
                        }
                    }

                    if (!st.active) {
                        // Done
                        startBtn.disabled = false; startBtn.style.opacity = '1';
                        stopBtn.classList.add('hidden');
                        appendLog(">>> Process finished.", false);
                        localStorage.removeItem('active_sync_id');
                        currentSyncId = null;
                        return;
                    }

                    setTimeout(poll, 2000);
                } catch (e) { setTimeout(poll, 5000); }
            };
            poll();
        }

        // Init
        restoreSession();
    </script>

    <!-- GUIDE MODAL (VIETNAMESE) -->
    <div id="guideModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeGuide()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden border border-slate-600 fade-in ring-1 ring-white/10">
                <div class="px-6 py-4 border-b border-slate-600 flex justify-between items-center bg-slate-900/50">
                    <div class="flex items-center gap-2">
                        <span class="bg-blue-500/10 text-blue-400 p-1.5 rounded-lg border border-blue-500/20">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                        </span>
                        <h3 class="font-bold text-slate-200 text-lg">Hướng Dẫn Sử Dụng (User Guide)</h3>
                    </div>
                    <button onclick="closeGuide()"
                        class="text-slate-500 hover:text-white transition-colors bg-slate-700/50 hover:bg-slate-700 rounded-lg p-1">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-0 text-sm text-slate-300">
                    <div class="grid grid-cols-1 md:grid-cols-3 min-h-full">
                        <!-- Sidebar -->
                        <div class="bg-slate-900/50 border-r border-slate-600 p-4 space-y-1">
                            <button onclick="scrollToSection('sec-intro')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">1.
                                Giới thiệu chung</button>
                            <button onclick="scrollToSection('sec-single')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">2.
                                Single Sync (Đơn)</button>
                            <button onclick="scrollToSection('sec-bulk')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">3.
                                Bulk Sync & CSV</button>
                            <button onclick="scrollToSection('sec-advanced')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">4.
                                Cấu hình nâng cao</button>
                            <button onclick="scrollToSection('sec-notes')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">5.
                                Lưu ý quan trọng</button>
                        </div>

                        <!-- Content -->
                        <div class="col-span-2 p-8 space-y-12 scroll-smooth" id="guideContent">

                            <!-- Intro -->
                            <section id="sec-intro" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm">1</span>
                                    Giới thiệu chung
                                </h4>
                                <p class="leading-relaxed text-slate-400">
                                    **IMAP Sync Pro** là công cụ hỗ trợ chuyển dữ liệu email (migration) từ server
                                    này
                                    sang server khác thông qua giao thức IMAP.
                                    Công cụ hỗ trợ chạy chạy nền với hiệu suất cao, tự động khôi phục tiến trình nếu
                                    trình duyệt bị tải lại, và cung cấp báo cáo chi tiết.
                                </p>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Single Sync -->
                            <section id="sec-single" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-sm">2</span>
                                    Single Sync (Chạy đơn lẻ)
                                </h4>
                                <div class="space-y-3 text-slate-400 leading-relaxed">
                                    <p>Chế độ này dùng để test hoặc chạy chuyển đổi cho **1 tài khoản duy nhất**.
                                    </p>
                                    <ul class="list-disc pl-5 space-y-2">
                                        <li><strong class="text-slate-200">Cấu hình:</strong> Nhập Host/User/Pass.
                                            <span class="text-slate-500 text-xs block mt-1">💡 Dùng nút <strong>Test
                                                    Conn</strong> để kiểm tra đăng nhập trước khi chạy. Bỏ tích
                                                <strong>SSL</strong> nếu dùng Port 143.</span>
                                        </li>
                                        <li><strong class="text-slate-200">Thao tác:</strong>
                                            Bấm <strong>Start</strong> để chạy. Bấm <strong>Stop</strong> để dừng ngay
                                            lập tức.
                                        </li>
                                        <li><strong class="text-slate-200">Dashboard:</strong>
                                            Theo dõi tiến độ và dùng nút <strong>Reset (Vòng tròn)</strong> để đặt lại
                                            số đếm về 0.
                                        </li>
                                    </ul>
                                </div>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Bulk Sync -->
                            <section id="sec-bulk" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center text-sm">3</span>
                                    Bulk Sync (Chạy hàng loạt)
                                </h4>
                                <div class="space-y-4 text-slate-400 leading-relaxed">
                                    <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                                        <h5 class="font-bold text-slate-200 mb-2">Định dạng file CSV</h5>
                                        <p class="mb-2">Bạn có thể nhập trực tiếp hoặc upload file `.csv` không có
                                            tiêu
                                            đề (header). Mỗi dòng là một tài khoản.</p>

                                        <div class="grid gap-4 mt-3">
                                            <div>
                                                <div class="text-xs font-bold text-blue-400 uppercase mb-1">Dạng 1:
                                                    Đơn
                                                    giản (Dùng chung Host)</div>
                                                <code
                                                    class="block bg-slate-950 p-3 rounded-lg font-mono text-xs text-emerald-400 break-all">user1,pass1,user1_new,pass2<br>user2,pass3,user2_new,pass4</code>
                                                <p class="text-xs mt-1 italic">Hệ thống sẽ dùng Host mặc định bạn
                                                    điền ở
                                                    trên.</p>
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-indigo-400 uppercase mb-1">Dạng
                                                    2:
                                                    Chi tiết (8 trường)</div>
                                                <code
                                                    class="block bg-slate-950 p-3 rounded-lg font-mono text-xs text-yellow-500 break-all">src_host,993,src_user,pass,dest_host,993,dest_user,pass</code>
                                            </div>
                                        </div>
                                    </div>
                                    <p>
                                        Sau khi nhập liệu, bấm <strong>Review Jobs</strong> để lên danh sách chờ.
                                        Bấm
                                        <strong>Start Batch</strong> để chạy.
                                        Bạn có thể chỉnh số luồng (Concurrency) để chạy song song nhiều tài khoản
                                        cùng
                                        lúc.
                                    </p>
                                    <p class="text-xs text-blue-400 italic">💡 Nếu có tài khoản bị lỗi (Error), nút
                                        <strong>Retry Failed Jobs</strong> sẽ hiện ra để bạn chạy lại riêng chúng.
                                    </p>
                                </div>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Advanced -->
                            <section id="sec-advanced" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm">4</span>
                                    Cấu hình nâng cao
                                </h4>
                                <ul class="list-disc pl-5 space-y-2 text-slate-400 leading-relaxed">
                                    <li><strong class="text-slate-200">Dry Run:</strong> Chạy mô phỏng, không copy
                                        dữ
                                        liệu thật, dùng để kiểm tra kết nối đăng nhập.</li>
                                    <li><strong class="text-slate-200">Sync from Date:</strong> Chỉ copy email từ
                                        ngày
                                        này trở đi.</li>
                                    <li><strong class="text-slate-200">Exclude Folders:</strong> Bỏ qua các thư mục
                                        không cần thiết (VD: Trash, Spam, Junk). Cách nhau bằng dấu phẩy.</li>
                                    <li><strong class="text-slate-200">Smart Map (Auto):</strong> Tự động nhận diện
                                        và
                                        ghép cặp các thư mục đặc biệt (Sent, Trash, Spam) giữa 2 server khác loại.
                                    </li>
                                    <li>
                                        <strong class="text-slate-200">Folder Mapping (Manual):</strong> Chuyển đổi
                                        tên
                                        thư mục thủ công.
                                        <div
                                            class="mt-1 bg-slate-900/50 p-2 rounded-lg border border-slate-700 text-xs font-mono text-emerald-400">
                                            Sent Messages:Sent Items<br>Drafts:Drafts New
                                        </div>
                                    </li>
                                </ul>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Notes -->
                            <section id="sec-notes" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-red-600 text-white flex items-center justify-center text-sm">5</span>
                                    Lưu ý quan trọng
                                </h4>
                                <div
                                    class="bg-red-500/10 border border-red-500/20 p-4 rounded-xl text-red-200 text-sm space-y-2">
                                    <p>⚠️ <strong>Gmail:</strong> Phải bật "2-Step Verification" và tạo <strong>App
                                            Password</strong> thì mới kết nối được. Mật khẩu đăng nhập thường sẽ
                                        không
                                        hoạt động.</p>
                                    <p>⚠️ <strong>Outlook/Office365:</strong> Một số tổ chức chặn IMAP, cần liên hệ
                                        admin mở quyền. Dùng App Password nếu có 2FA.</p>
                                    <p>⚠️ <strong>SSL/TLS:</strong> Mặc định Port 993 dùng SSL (Secure). Nếu server cũ
                                        không hỗ trợ SSL (thường là Port 143), hãy bỏ tích ô <strong>SSL</strong> cạnh ô
                                        Port.</p>
                                    <p>⚠️ <strong>Không đóng tab trình duyệt:</strong> Mặc dù hệ thống có cơ chế
                                        khôi
                                        phục, nhưng để ổn định nhất, hãy giữ tab trình duyệt mở khi đang chạy Batch
                                        lớn.
                                    </p>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-slate-600 bg-slate-900/50 flex justify-end">
                    <button onclick="closeGuide()"
                        class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 transition-all text-sm">Đã
                        hiểu / Got it</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function togglePort(type) {
            const secure = document.getElementById(type + '_secure').checked;
            document.getElementById(type + '_port').value = secure ? 993 : 143;
        }

        async function testConnection(type) {
            const host = document.getElementById(type + '_host').value;
            const port = document.getElementById(type + '_port').value;
            const user = document.getElementById(type + '_user').value;
            const pass = document.getElementById(type + '_pass').value;
            const secure = document.getElementById(type + '_secure').checked;

            if (!host || !user || !pass) {
                showInfo("Missing Info", "Please enter Host, User, and Password.", true);
                return;
            }

            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin h-3.5 w-3.5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Testing...`;

            try {
                const res = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ host, port, user, pass, secure })
                });
                const data = await res.json();

                if (data.success) {
                    showInfo("Success", "Connection successful! ✅", false);
                } else {
                    showInfo("Connection Failed", data.error, true);
                }
            } catch (e) {
                showInfo("Error", e.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Stats Polling
        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function resetStats() {
            const ok = await showConfirm("Reset Statistics?", "Are you sure you want to reset all migration statistics?");
            if (!ok) return;

            try {
                const res = await fetch('/api/stats/reset', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showInfo("Stats Reset", "Migration statistics have been reset.", false);
                    // Immediately update UI
                    document.getElementById('stat_emails').textContent = '0';
                    document.getElementById('stat_bytes').textContent = '0 B';
                } else {
                    showInfo("Error", "Failed to reset statistics.", true);
                }
            } catch (e) {
                showInfo("Error", "Network error while resetting statistics: " + e.message, true);
            }
        }

        setInterval(async () => {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('stat_emails').textContent = stats.totalEmails.toLocaleString();
                document.getElementById('stat_bytes').textContent = formatBytes(stats.totalBytes);

                // Also check for failures to show Retry button
                const hasFailed = bulkJobs.some(j => j.status === 'Error');
                const retryBtn = document.getElementById('btnRetryFailed');
                if (retryBtn) {
                    if (hasFailed && !isBatchRunning) {
                        retryBtn.classList.remove('hidden');
                    } else {
                        retryBtn.classList.add('hidden');
                    }
                }

            } catch (e) { }
        }, 3000);

        function retryFailed() {
            let count = 0;
            bulkJobs.forEach(job => {
                if (job.status === 'Error') {
                    job.status = 'Pending';
                    job.progress = 0;
                    job.lastLog = 'Retrying...';
                    // Reset UI
                    const stEl = document.getElementById(`status-${job.id}`);
                    if (stEl) { stEl.textContent = 'Pending'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400 border border-slate-600 mb-1"; }
                    count++;
                }
            });

            if (count > 0) {
                saveBatchState();
                startBatch();
                showInfo("Retrying", `Restarting ${count} failed jobs...`, false);
            } else {
                showInfo("No Failures", "No failed jobs to retry.", true);
            }
        }

        function showGuide() {
            document.getElementById('guideModal').classList.remove('hidden');
        }
        function closeGuide() {
            document.getElementById('guideModal').classList.add('hidden');
        }
        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Init
        restoreSession();
    </script>
</body>

</html>