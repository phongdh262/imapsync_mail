<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAP Sync Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FONTS: Inter for UI, JetBrains Mono for Code/Logs -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 4px;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .fade-in-fast {
            animation: fadeIn 0.15s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-900 min-h-screen text-slate-200 antialiased selection:bg-blue-500 selection:text-white">

    <div class="max-w-[1800px] mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-blue-500/20 rounded-2xl border border-blue-400/30 shadow-lg shadow-blue-500/10">
                    <svg class="w-8 h-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">IMAP Sync Pro</h1>
                    <p class="text-slate-400 text-sm">Batch Migration Tool with Advanced Filters</p>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex items-center gap-4">
                <div class="bg-slate-800 p-1.5 rounded-xl border border-slate-600 inline-flex shadow-lg">
                    <button onclick="switchTab('single')" id="tab-single"
                        class="px-6 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 shadow-md bg-blue-600 text-white shadow-blue-900/20">
                        Single Sync
                    </button>
                    <button onclick="switchTab('bulk')" id="tab-bulk"
                        class="px-6 py-2.5 rounded-lg text-sm font-bold text-slate-400 hover:text-white hover:bg-slate-700 transition-all duration-300">
                        Bulk Sync (CSV)
                    </button>
                </div>
                <button onclick="showGuide()"
                    class="p-3 bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 rounded-xl transition-colors shadow-lg group"
                    title="HÆ°á»›ng dáº«n sá»­ dá»¥ng">
                    <svg class="w-6 h-6 group-hover:text-blue-400 transition-colors" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- MAIN LAYOUT: EVEN SPLIT SCREEN (50/50) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start h-full">

            <!-- LEFT COLUMN: INPUTS -->
            <div class="space-y-6">

                <!-- SINGLE SYNC INPUTS -->
                <div id="input-single" class="fade-in space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Source Card (Lighter Slate-800) -->
                        <div
                            class="bg-slate-800 rounded-3xl p-6 shadow-lg border border-slate-600 transition-all hover:border-blue-400/50 group">
                            <h2
                                class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-3 uppercase tracking-wider">
                                <span
                                    class="w-6 h-6 rounded-full bg-blue-500/20 text-blue-300 flex items-center justify-center text-xs border border-blue-400/30">1</span>
                                Source
                            </h2>
                            <div class="space-y-3">
                                <input type="text" id="src_host"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-400 focus:ring-1 focus:ring-blue-400 outline-none text-sm transition-all text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Host (e.g. imap.gmail.com)">
                                <div class="grid grid-cols-3 gap-3">
                                    <input type="text" id="src_user"
                                        class="col-span-2 w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                        placeholder="Email / User">
                                    <input type="number" id="src_port" value="993"
                                        class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-400 outline-none text-sm text-center font-mono text-white shadow-inner">
                                </div>
                                <input type="password" id="src_pass"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Password">
                            </div>
                        </div>

                        <!-- Destination Card (Lighter Slate-800) -->
                        <div
                            class="bg-slate-800 rounded-3xl p-6 shadow-lg border border-slate-600 transition-all hover:border-indigo-400/50 group">
                            <h2
                                class="text-sm font-bold text-slate-300 mb-4 flex items-center gap-3 uppercase tracking-wider">
                                <span
                                    class="w-6 h-6 rounded-full bg-indigo-500/20 text-indigo-300 flex items-center justify-center text-xs border border-indigo-400/30">2</span>
                                Destination
                            </h2>
                            <div class="space-y-3">
                                <input type="text" id="dest_host"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-indigo-400 focus:ring-1 focus:ring-indigo-400 outline-none text-sm transition-all text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Host (e.g. imap.office.com)">
                                <div class="grid grid-cols-3 gap-3">
                                    <input type="text" id="dest_user"
                                        class="col-span-2 w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-indigo-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                        placeholder="Email / User">
                                    <input type="number" id="dest_port" value="993"
                                        class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-indigo-400 outline-none text-sm text-center font-mono text-white shadow-inner">
                                </div>
                                <input type="password" id="dest_pass"
                                    class="w-full px-4 py-3 rounded-xl bg-slate-700 border border-slate-600 focus:border-indigo-400 outline-none text-sm text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Password">
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="bg-slate-800 p-5 rounded-2xl border border-slate-600 shadow-sm">
                        <button
                            class="flex items-center justify-between w-full text-xs font-bold text-slate-300 hover:text-white transition-colors uppercase tracking-wider mb-2"
                            onclick="document.getElementById('advConfig').classList.toggle('hidden')">
                            <span>Configuration & Filters</span>
                            <div class="bg-slate-700 p-1 rounded-md border border-slate-600">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </button>
                        <div id="advConfig" class="hidden space-y-4 pt-4 border-t border-slate-600 mt-2 fade-in">
                            <div class="flex items-center gap-6">
                                <div class="flex items-center gap-3">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" id="smartMap" checked
                                            class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-500 bg-slate-700 checked:border-blue-500 checked:bg-blue-600 transition-all">
                                        <svg class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100"
                                            viewBox="0 0 14 14" fill="none">
                                            <path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </div>
                                    <label for="smartMap"
                                        class="text-sm font-medium text-slate-300 pointer-events-none">Smart Map</label>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" id="dryRun"
                                            class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-slate-500 bg-slate-700 checked:border-blue-500 checked:bg-blue-600 transition-all">
                                        <svg class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100"
                                            viewBox="0 0 14 14" fill="none">
                                            <path d="M3 8L6 11L11 3.5" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </div>
                                    <label for="dryRun"
                                        class="text-sm font-medium text-slate-300 pointer-events-none">Dry
                                        Run Mode <span class="text-slate-500 ml-1 text-xs">(Simulate
                                            only)</span></label>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase">Sync
                                    From</label>
                                <input type="date" id="sinceDate"
                                    class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-sm outline-none focus:border-blue-400 text-white shadow-inner">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase">Exclude
                                    Folders</label>
                                <input type="text" id="excludeFolders"
                                    class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-sm outline-none focus:border-blue-400 text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Trash, Spam">
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div
                        class="bg-slate-800 p-6 rounded-3xl shadow-xl border border-slate-600 flex flex-col items-center gap-6">
                        <div class="w-full">
                            <div
                                class="flex justify-between text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                                <span>Concurrency Level</span>
                                <span class="text-blue-400 font-mono" id="concurrencyVal">1 Thread</span>
                            </div>
                            <input type="range" id="concurrency" min="1" max="10" value="1"
                                class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400">
                        </div>
                        <div class="flex gap-4 w-full">
                            <button id="startSync"
                                class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-2xl shadow-lg shadow-blue-900/40 hover:-translate-y-0.5 transition-all text-sm flex items-center justify-center gap-2 group">
                                Start Migration
                                <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                </svg>
                            </button>
                            <button id="stopSync"
                                class="hidden flex-1 py-4 bg-slate-700 text-red-500 font-bold rounded-2xl border border-red-900/30 hover:bg-red-900/20 transition-all text-sm">
                                Stop
                            </button>
                        </div>
                    </div>
                </div>



                <!-- BULK SYNC INPUTS -->
                <div id="input-bulk" class="hidden fade-in space-y-6">
                    <!-- Default Settings -->
                    <div class="bg-slate-800 p-6 rounded-3xl border border-slate-600 shadow-lg">
                        <h3 class="text-xs font-bold text-slate-400 mb-4 uppercase tracking-wider">Default
                            Configuration
                        </h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600">
                                <h4 class="text-[10px] font-bold text-blue-400 mb-2 uppercase">Source Default</h4>
                                <div class="grid grid-cols-3 gap-3">
                                    <input type="text" id="def_src_host"
                                        class="col-span-2 w-full px-3 py-2.5 rounded-lg bg-slate-700 border border-slate-600 text-xs focus:border-blue-400 outline-none text-white placeholder-slate-400 shadow-inner"
                                        placeholder="Host">
                                    <input type="number" id="def_src_port" value="993"
                                        class="w-full px-3 py-2.5 rounded-lg bg-slate-700 border border-slate-600 text-xs text-center font-mono text-white shadow-inner">
                                </div>
                            </div>
                            <div class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600">
                                <h4 class="text-[10px] font-bold text-indigo-400 mb-2 uppercase">Dest Default</h4>
                                <div class="grid grid-cols-3 gap-3">
                                    <input type="text" id="def_dest_host"
                                        class="col-span-2 w-full px-3 py-2.5 rounded-lg bg-slate-700 border border-slate-600 text-xs focus:border-indigo-400 outline-none text-white placeholder-slate-400 shadow-inner"
                                        placeholder="Host">
                                    <input type="number" id="def_dest_port" value="993"
                                        class="w-full px-3 py-2.5 rounded-lg bg-slate-700 border border-slate-600 text-xs text-center font-mono text-white shadow-inner">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk CSV Input -->
                    <div class="bg-slate-800 rounded-3xl p-6 shadow-xl border border-slate-600 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-sm font-bold text-slate-300">CSV Data</div>
                            <label
                                class="cursor-pointer text-xs font-bold text-blue-400 bg-blue-500/10 border border-blue-500/20 px-3 py-1.5 rounded-lg hover:bg-blue-500/20 transition-colors">
                                <input type="file" id="csvFile" accept=".csv" class="hidden"> Upload File
                            </label>
                        </div>
                        <textarea id="bulkInput" rows="12"
                            class="w-full p-4 rounded-xl bg-slate-700 text-slate-300 font-mono text-xs border border-slate-600 leading-relaxed focus:border-blue-400 outline-none resize-none shadow-inner"
                            placeholder="user1,pass1,user1_new,pass2"></textarea>

                        <!-- Bulk Advanced -->
                        <div class="mt-4 pt-4 border-t border-slate-600">
                            <button
                                class="flex items-center justify-between w-full text-xs font-bold text-slate-400 hover:text-white transition-colors mb-2"
                                onclick="document.getElementById('bulkAdvConfig').classList.toggle('hidden')">
                                <span>Bulk Options (Date, Exclude) ðŸ”§</span>
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="bulkAdvConfig" class="hidden grid grid-cols-2 gap-3 mt-3">
                                <div class="col-span-2 flex items-center gap-4 mb-1">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="bulkSmartMap" checked
                                            class="h-4 w-4 rounded border-slate-500 bg-slate-700 text-blue-600">
                                        <label for="bulkSmartMap" class="text-xs font-bold text-slate-400"
                                            title="Auto-detect Sent/Trash/Spam folders">Smart Map</label>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="bulkDryRun"
                                            class="h-4 w-4 rounded border-slate-500 bg-slate-700 text-blue-600">
                                        <label for="bulkDryRun" class="text-xs font-bold text-slate-400">Dry
                                            Run</label>
                                    </div>
                                </div>
                                <input type="date" id="bulkSinceDate"
                                    class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-xs text-slate-400 outline-none shadow-inner">
                                <input type="text" id="bulkExcludeFolders"
                                    class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-xs outline-none text-white placeholder-slate-400 shadow-inner"
                                    placeholder="Exclude Folders (e.g. Trash, Spam)">
                                <textarea id="folderMapping" rows="3"
                                    class="col-span-2 w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-xs outline-none text-white placeholder-slate-400 shadow-inner font-mono"
                                    placeholder="Folder Mapping (Source:Dest, one per line)&#10;Sent Messages:Sent Items&#10;Drafts:Drafts New"></textarea>
                            </div>
                        </div>

                        <!-- Bulk Controls -->
                        <div class="mt-6 flex flex-col gap-3">
                            <div
                                class="flex items-center justify-between bg-slate-900 px-4 py-3 rounded-xl border border-slate-700">
                                <span class="text-xs font-bold text-slate-500 uppercase">Batch Concurrency</span>
                                <input type="number" id="batchConcurrency" value="3" min="1" max="5"
                                    class="w-12 bg-slate-800 border border-slate-600 rounded text-center text-sm font-bold outline-none text-white focus:border-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="parseAndLoad()"
                                    class="py-3 bg-slate-700 border border-slate-600 text-slate-300 font-bold rounded-xl hover:bg-slate-600 hover:text-white transition-all text-xs uppercase tracking-wider">Preview
                                    Jobs</button>
                                <button onclick="startBatch()" id="btnStartBatch"
                                    class="py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 hover:bg-blue-500 transition-all text-xs uppercase tracking-wider disabled:opacity-50"
                                    disabled>Start Batch</button>
                                <button onclick="stopBatch()" id="btnStopBatch"
                                    class="hidden col-span-2 py-3 bg-red-500/10 text-red-500 font-bold rounded-xl border border-red-500/20 hover:bg-red-500/20">Stop
                                    All</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- RIGHT COLUMN: OUTPUTS -->
            <div class="space-y-6 h-full min-h-[600px] lg:min-h-0 lg:h-[calc(100vh-8rem)] sticky top-6">

                <!-- SINGLE OUTPUT -->
                <div id="output-single" class="fade-in h-full flex flex-col">
                    <div
                        class="bg-slate-800 rounded-3xl overflow-hidden shadow-2xl border border-slate-600 flex flex-col h-full ring-1 ring-white/5">
                        <div
                            class="px-5 py-4 bg-slate-900/50 border-b border-slate-600 flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Terminal
                                    Output</span>
                            </div>
                            <div class="flex gap-1.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-red-500/20 border border-red-500/30"></div>
                                <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20 border border-yellow-500/30">
                                </div>
                                <div class="w-2.5 h-2.5 rounded-full bg-green-500/20 border border-green-500/30">
                                </div>
                            </div>
                        </div>
                        <div id="logs"
                            class="p-6 overflow-y-auto font-mono text-xs md:text-sm text-slate-300 leading-relaxed scroll-smooth flex-1 bg-slate-900/80 shadow-inner">
                            <div class="text-slate-500 italic select-none">Waiting for process start...</div>
                        </div>
                    </div>
                </div>

                <!-- BULK OUTPUT -->
                <div id="output-bulk" class="hidden fade-in h-full">
                    <div
                        class="bg-slate-800 rounded-3xl shadow-xl border border-slate-600 overflow-hidden flex flex-col h-full ring-1 ring-white/5">
                        <div
                            class="px-6 py-4 border-b border-slate-600 bg-slate-900/30 flex justify-between items-center shrink-0">
                            <h3 class="font-bold text-slate-300 text-sm">Active Job Queue</h3>
                            <button onclick="downloadReport()"
                                class="text-xs font-bold text-emerald-500 hover:text-emerald-400 flex items-center gap-1.5 bg-emerald-500/10 px-3 py-1.5 rounded-lg border border-emerald-500/20 transition-colors">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Export Report
                            </button>
                        </div>
                        <div id="jobsContainer" class="hidden flex-1 flex flex-col overflow-hidden">
                            <div class="overflow-y-auto flex-1">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr
                                            class="bg-slate-900/50 border-b border-slate-600 text-[10px] text-slate-500 uppercase font-bold tracking-wider sticky top-0 backdrop-blur-md">
                                            <th class="px-6 py-3">Migration Context</th>
                                            <th class="px-6 py-3">Status</th>
                                            <th class="px-6 py-3 w-1/4">Progress</th>
                                            <th class="px-6 py-3 text-right">Controls</th>
                                        </tr>
                                    </thead>
                                    <tbody id="jobsTableBody" class="divide-y divide-slate-600 text-sm"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="jobsPlaceholder"
                            class="flex-1 flex flex-col items-center justify-center p-10 text-slate-500">
                            <div class="bg-slate-900/50 p-6 rounded-full mb-4">
                                <svg class="w-12 h-12 text-slate-600" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                            </div>
                            <p class="text-sm font-medium">No jobs queued. Load a CSV to begin.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>



    <!-- LOG MODAL -->
    <div id="logModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[80vh] overflow-hidden border border-slate-600 fade-in">
                <div class="px-6 py-4 border-b border-slate-600 flex justify-between items-center bg-slate-900/50">
                    <h3 class="font-bold text-slate-200" id="modalTitle">Logs</h3>
                    <button onclick="closeModal()" class="text-slate-500 hover:text-white transition-colors">âœ•</button>
                </div>
                <div id="modalLogContent"
                    class="flex-1 overflow-y-auto bg-slate-900 p-6 font-mono text-xs text-slate-300"></div>
            </div>
        </div>
    </div>

    <!-- CONFIRM CUSTOM MODAL -->
    <div id="confirmModal" class="fixed inset-0 z-[60] hidden">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeConfirm(false)">
        </div>
        <div class="fixed inset-0 z-[70] flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-600 fade-in-fast flex flex-col overflow-hidden ring-1 ring-white/10">
                <div class="p-6 text-center">
                    <div
                        class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                        <svg class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2" id="confirmTitle">Confirm Action</h3>
                    <p class="text-sm text-slate-400 leading-relaxed" id="confirmMsg">Are you sure you want to
                        proceed?
                    </p>
                </div>
                <div class="flex border-t border-slate-700">
                    <button onclick="closeConfirm(false)"
                        class="flex-1 py-4 text-sm font-bold text-slate-400 hover:bg-slate-700/50 hover:text-white transition-colors">Cancel</button>
                    <div class="w-px bg-slate-700"></div>
                    <button onclick="closeConfirm(true)"
                        class="flex-1 py-4 text-sm font-bold text-red-400 hover:bg-red-500/10 hover:text-red-300 transition-colors">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INFO CUSTOM MODAL (NEW) -->
    <div id="infoModal" class="fixed inset-0 z-[60] hidden">
        <div class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closeInfo()"></div>
        <div class="fixed inset-0 z-[70] flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-600 fade-in-fast flex flex-col overflow-hidden ring-1 ring-white/10">
                <div class="p-6 text-center">
                    <div
                        class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/20">
                        <svg class="w-8 h-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2" id="infoTitle">Notification</h3>
                    <p class="text-sm text-slate-400 leading-relaxed" id="infoMsg">Message</p>
                </div>
                <div class="flex border-t border-slate-700">
                    <button onclick="closeInfo()"
                        class="flex-1 py-4 text-sm font-bold text-blue-400 hover:bg-slate-700/50 transition-colors">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UTILS ---
        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0; return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });

        function formatIMAPDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${d.getDate()}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        // --- TABS & UI ---
        document.getElementById('csvFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) { document.getElementById('bulkInput').value = e.target.result; };
            reader.readAsText(file);
        });

        function switchTab(tab) {
            // Hide all first
            ['input-single', 'input-bulk', 'output-single', 'output-bulk'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            const sBtn = document.getElementById('tab-single');
            const bBtn = document.getElementById('tab-bulk');

            const activeClass = "px-6 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 shadow-md bg-blue-600 text-white shadow-blue-900/20";
            const inactiveClass = "px-6 py-2.5 rounded-lg text-sm font-bold text-slate-400 hover:text-white hover:bg-slate-700 transition-all duration-300";

            if (tab === 'single') {
                document.getElementById('input-single').classList.remove('hidden');
                document.getElementById('output-single').classList.remove('hidden');
                sBtn.className = activeClass;
                bBtn.className = inactiveClass;
            } else {
                document.getElementById('input-bulk').classList.remove('hidden');
                document.getElementById('output-bulk').classList.remove('hidden');
                bBtn.className = activeClass;
                sBtn.className = inactiveClass;
            }
        }

        // --- SINGLE SYNC ---
        const startBtn = document.getElementById('startSync');
        const stopBtn = document.getElementById('stopSync');
        const logsDiv = document.getElementById('logs');
        const concurrencyInput = document.getElementById('concurrency');
        let currentSyncId = null;

        concurrencyInput.addEventListener('input', (e) => {
            document.getElementById('concurrencyVal').textContent = `${e.target.value} Thread${e.target.value > 1 ? 's' : ''}`;
        });

        function appendLog(msg, isError = false) {
            // If logsDiv has placeholder, remove it
            if (logsDiv.querySelector('.italic')) logsDiv.innerHTML = '';

            const div = document.createElement('div');
            div.className = isError ? 'text-red-400 mb-1 border-l-2 border-red-500/50 pl-2' : 'mb-1 border-l-2 border-slate-600 pl-2';
            div.textContent = msg;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }


        function parseFolderMapping() {
            const raw = document.getElementById('folderMapping').value;
            if (!raw.trim()) return {};
            const mapping = {};
            raw.split('\n').forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const src = parts[0].trim();
                    const dest = parts.slice(1).join(':').trim(); // Handle dest containing colons
                    if (src && dest) mapping[src] = dest;
                }
            });
            return mapping;
        }

        startBtn.addEventListener('click', async () => {
            const folderMap = parseFolderMapping();
            const data = {
                src_host: document.getElementById('src_host').value,
                src_port: document.getElementById('src_port').value,
                src_user: document.getElementById('src_user').value,
                src_pass: document.getElementById('src_pass').value,
                dest_host: document.getElementById('dest_host').value,
                dest_port: document.getElementById('dest_port').value,
                dest_user: document.getElementById('dest_user').value,
                dest_pass: document.getElementById('dest_pass').value,
                concurrency: concurrencyInput.value,
                sync_id: generateUUID(),
                // NEW ADVANCED PARAMS
                dry_run: document.getElementById('dryRun').checked,
                smart_map: document.getElementById('smartMap').checked,
                since_date: formatIMAPDate(document.getElementById('sinceDate').value),
                exclude_folders: document.getElementById('excludeFolders').value,
                folder_mapping: folderMap
            };
            currentSyncId = data.sync_id;

            if (!data.src_host || !data.src_user || !data.src_pass) { showInfo("Configuration Error", "Please fill in all required Source and Destination fields."); return; }

            // Save session
            localStorage.setItem('active_sync_id', currentSyncId);
            localStorage.setItem('active_sync_config', JSON.stringify(data));

            startBtn.disabled = true; startBtn.style.opacity = '0.5';
            stopBtn.classList.remove('hidden');
            logsDiv.innerHTML = ''; // Clear logs

            if (Object.keys(folderMap).length > 0) {
                appendLog(`>>> Folder Mapping Configured: ${Object.keys(folderMap).length} rules.`, false);
            }
            if (data.dry_run) appendLog(">>> DRY RUN MODE: No data will be transferred.", false);
            appendLog("Connecting...", false);

            await runSyncStream(data, (msg, isErr) => appendLog(msg, isErr), () => { });

            startBtn.disabled = false; startBtn.style.opacity = '1';
            stopBtn.classList.add('hidden');
        });

        stopBtn.addEventListener('click', async () => {
            if (currentSyncId) {
                await fetch('/api/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sync_id: currentSyncId }) });
                localStorage.removeItem('active_sync_id');
                // localStorage.removeItem('active_sync_config'); // Keep config for ease
            }
        });

        async function runSyncStream(data, logCtx, progCtx) {
            try {
                const response = await fetch('/api/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    const lines = decoder.decode(value).split('\n\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const p = JSON.parse(line.replace('data: ', ''));
                                logCtx(p.message, p.is_error);
                                if (p.progress !== undefined) progCtx(p.progress);

                                if (p.message === 'Sync completed!' || p.message === 'Stopped by user.') {
                                    localStorage.removeItem('active_sync_id');
                                }
                            } catch (e) { }
                        }
                    });
                }
            } catch (err) { logCtx("Network Error: " + err, true); }
        }

        // --- BULK SYNC ---
        let bulkJobs = [];
        let isBatchRunning = false;
        let shouldStopBatch = false; // Flag for Stop All
        let currentViewedJobId = null;

        function inferHost(email) {
            if (!email) return 'imap.gmail.com';
            if (email.includes('@gmail')) return 'imap.gmail.com';
            if (email.includes('@outlook') || email.includes('@office')) return 'outlook.office365.com';
            const parts = email.split('@');
            return parts.length > 1 ? `imap.${parts[1]}` : 'imap.gmail.com';
        }

        function parseCSVLine(str) {
            const arr = []; let quote = false; let col = '';
            for (let c of str) {
                if (c === '"') { quote = !quote; continue; }
                if (c === ',' && !quote) { arr.push(col); col = ''; continue; }
                col += c;
            }
            arr.push(col); return arr.map(s => s.trim());
        }

        function parseAndLoad() {
            const text = document.getElementById('bulkInput').value.trim();
            const defSrcHost = document.getElementById('def_src_host').value.trim();
            const defDestHost = document.getElementById('def_dest_host').value.trim();

            bulkJobs = [];
            text.split('\n').forEach(line => {
                if (!line.trim() || line.trim().startsWith('#')) return;
                const p = parseCSVLine(line.trim());
                let job = { status: 'Pending', progress: 0, id: generateUUID(), fullLogs: [] };

                if (p.length >= 8) {
                    Object.assign(job, { src_host: p[0], src_port: p[1], src_user: p[2], src_pass: p[3], dest_host: p[4], dest_port: p[5], dest_user: p[6], dest_pass: p[7] });
                } else if (p.length >= 4) {
                    Object.assign(job, {
                        src_host: defSrcHost || inferHost(p[0]), src_port: '993', src_user: p[0], src_pass: p[1],
                        dest_host: defDestHost || inferHost(p[2]), dest_port: '993', dest_user: p[2], dest_pass: p[3]
                    });
                } else return;
                bulkJobs.push(job);
            });

            if (bulkJobs.length > 0) {
                renderJobs();
                document.getElementById('jobsContainer').classList.remove('hidden');
                document.getElementById('jobsPlaceholder').classList.add('hidden'); // Hide placeholder
                document.getElementById('btnStartBatch').disabled = false;
            }
        }

        function renderJobs() {
            const tbody = document.getElementById('jobsTableBody');
            tbody.innerHTML = '';
            bulkJobs.forEach((job) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-900 transition-colors group border-b border-slate-600";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex flex-col gap-1">
                             <div class="font-bold text-slate-300 break-all" title="${job.src_user}">${job.src_user}</div>
                             <div class="text-[10px] text-slate-500 uppercase tracking-wide">to</div>
                             <div class="font-bold text-slate-300 break-all" title="${job.dest_user}">${job.dest_user}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span id="status-${job.id}" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400 border border-slate-600 mb-1">${job.status}</span>
                        <div id="lastlog-${job.id}" class="text-[10px] text-slate-500 truncate w-32 cursor-pointer hover:text-blue-400 transition-colors" onclick="viewLogs('${job.id}')">${job.lastLog || 'Waiting...'}</div>
                    </td>
                    <td class="px-6 py-4">
                         <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden mb-2 border border-slate-600"><div id="prog-${job.id}" class="bg-blue-600 h-full rounded-full transition-all" style="width: ${job.progress}%"></div></div>
                    </td>
                    <td class="px-6 py-4 text-right">
                         <button onclick="viewLogs('${job.id}')" class="text-xs font-bold text-slate-500 hover:text-blue-400 mr-3 transition-colors">LOGS</button>
                         <button onclick="stopJob('${job.id}')" class="text-xs font-bold text-red-400 hover:text-red-300 transition-colors ${job.status !== 'Running' ? 'hidden' : ''}" id="stop-${job.id}">STOP</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveBatchState() {
            localStorage.setItem('active_batch_jobs', JSON.stringify(bulkJobs));
            localStorage.setItem('is_batch_running', isBatchRunning);
        }

        async function startBatch() {
            if (isBatchRunning) return; isBatchRunning = true; shouldStopBatch = false;
            document.getElementById('btnStartBatch').disabled = true;
            document.getElementById('btnStopBatch').classList.remove('hidden');

            saveBatchState(); // Save initial state

            // CAPTURE BULK SETTINGS ONLY ONCE AT START
            const bulkSettings = {
                dry_run: document.getElementById('bulkDryRun').checked,
                smart_map: document.getElementById('bulkSmartMap').checked,
                since_date: formatIMAPDate(document.getElementById('bulkSinceDate').value),
                exclude_folders: document.getElementById('bulkExcludeFolders').value,
                folder_mapping: parseFolderMapping()
            };

            const batchConcurrent = parseInt(document.getElementById('batchConcurrency').value) || 2;
            let idx = 0, active = 0;

            const runNext = async () => {
                if (shouldStopBatch) {
                    if (active === 0) cleanupBatch();
                    return;
                }

                // Skip already Done/Error (for resume support)
                while (idx < bulkJobs.length && (bulkJobs[idx].status === 'Done' || bulkJobs[idx].status === 'Error' || bulkJobs[idx].status === 'Stopped')) {
                    idx++;
                }

                if (idx >= bulkJobs.length) {
                    if (active === 0) cleanupBatch();
                    return;
                }
                const jobIdx = idx++; active++;
                const job = bulkJobs[jobIdx];

                job.status = 'Running';
                saveBatchState();

                const stEl = document.getElementById(`status-${job.id}`);
                if (stEl) { stEl.textContent = 'Running'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-500/30 mb-1"; }
                document.getElementById(`stop-${job.id}`).classList.remove('hidden');

                // Get concurrency from slider (default 2 if not found)
                const threadConcurrency = parseInt(document.getElementById('concurrency').value) || 2;
                // MERGE JOB DATA WITH ADV MODES
                const jobData = { ...job, concurrency: threadConcurrency, sync_id: job.id, ...bulkSettings };

                await runSyncStream(jobData,
                    (msg, isErr) => {
                        if (job.status === 'Stopped') return; // Ignore logs if stopped

                        job.lastLog = msg; job.fullLogs.push({ msg, isError: isErr });
                        const logEl = document.getElementById(`lastlog-${job.id}`);
                        if (logEl) logEl.textContent = msg;

                        const modal = document.getElementById('logModal');
                        if (!modal.classList.contains('hidden') && currentViewedJobId === job.id) {
                            const el = document.getElementById('modalLogContent');
                            const d = document.createElement('div'); d.className = isErr ? "text-red-400 mb-1" : "text-slate-300 mb-1"; d.textContent = msg;
                            el.appendChild(d); el.scrollTop = el.scrollHeight;
                        }

                        // Only mark as Failed if strictly Critical
                        if (isErr && msg.includes('Critical Error')) {
                            job.status = 'Error';
                            saveBatchState();
                            if (stEl) { stEl.textContent = 'Failed'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-red-900/30 text-red-400 border border-red-500/30 mb-1"; }
                        }
                    },
                    (prog) => {
                        if (job.status === 'Stopped') return;

                        job.progress = prog;
                        const progEl = document.getElementById(`prog-${job.id}`);
                        if (progEl) progEl.style.width = prog + '%';
                        if (prog === 100) {
                            job.status = 'Done';
                            saveBatchState();
                            if (stEl) { stEl.textContent = 'Done'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 mb-1"; }
                            document.getElementById(`stop-${job.id}`).classList.add('hidden');
                        }
                    }
                );

                active--;
                if (shouldStopBatch) {
                    // Check again if we should stop
                    if (active === 0) cleanupBatch();
                } else {
                    runNext();
                }
            };

            for (let i = 0; i < batchConcurrent; i++) runNext();
        }

        function cleanupBatch() {
            isBatchRunning = false;
            document.getElementById('btnStartBatch').disabled = false;
            document.getElementById('btnStopBatch').classList.add('hidden');
            if (shouldStopBatch) showInfo("Batch Stopped", "Batch processing has been stopped."); else showInfo("Batch Completed", "All jobs in the queue have been processed.");

            // Check if all really done to clear
            const allDone = bulkJobs.every(j => j.status === 'Done' || j.status === 'Error' || j.status === 'Stopped');
            if (allDone) {
                localStorage.removeItem('active_batch_jobs');
                localStorage.removeItem('is_batch_running');
            }
        }

        // --- CUSTOM CONFIRM MODAL LOGIC ---
        let confirmResolve = null;
        function showConfirm(title, msg) {
            return new Promise((resolve) => {
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMsg').textContent = msg;
                document.getElementById('confirmModal').classList.remove('hidden');
                confirmResolve = resolve;
            });
        }
        function closeConfirm(result) {
            document.getElementById('confirmModal').classList.add('hidden');
            if (confirmResolve) confirmResolve(result);
            confirmResolve = null;
        }

        async function stopBatch() {
            const ok = await showConfirm("Stop All Jobs?", "Are you sure you want to stop all running tasks? This action cannot be undone.");
            if (!ok) return;

            shouldStopBatch = true; // Prevent new jobs

            // Stop all currently running jobs
            const activeJobIds = bulkJobs.filter(j => j.status === 'Running' || j.status === 'Restoring').map(j => j.id);
            for (let id of activeJobIds) {
                stopJob(id, false); // false = don't confirm for each
            }
        }

        // --- REPORT & MODAL ---
        function downloadReport() {
            if (!bulkJobs.length) return showInfo("No Data", "There are no jobs to export.");
            const header = ["Source", "Dest", "Status", "Last Log"];
            const rows = bulkJobs.map(j => [j.src_user, j.dest_user, j.status, `"${j.lastLog}"`]);
            const csv = "data:text/csv;charset=utf-8," + header.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "report.csv";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function viewLogs(id) {
            const job = bulkJobs.find(j => j.id === id); if (!job) return;
            currentViewedJobId = id;
            document.getElementById('modalTitle').textContent = `Logs: ${job.src_user}`;
            const el = document.getElementById('modalLogContent');
            el.innerHTML = job.fullLogs.map(l => `<div class="${l.isError ? 'text-red-400' : 'text-slate-300'} mb-1">${l.msg}</div>`).join('');
            document.getElementById('logModal').classList.remove('hidden');
            el.scrollTop = el.scrollHeight;
        }
        function closeModal() { document.getElementById('logModal').classList.add('hidden'); currentViewedJobId = null; }

        // --- INFO MODAL LOGIC ---
        function showInfo(title, msg) {
            document.getElementById('infoTitle').textContent = title;
            document.getElementById('infoMsg').textContent = msg;
            document.getElementById('infoModal').classList.remove('hidden');
        }
        function closeInfo() {
            document.getElementById('infoModal').classList.add('hidden');
        }

        async function stopJob(id, ask = true) {
            if (ask) {
                const ok = await showConfirm("Stop Job?", "Are you sure you want to stop this migration task?");
                if (!ok) return;
            }
            try {
                await fetch('/api/stop', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sync_id: id }) });
                // Mark as Stopped in UI immediately 
                const job = bulkJobs.find(j => j.id === id);
                if (job) {
                    job.status = 'Stopped';
                    job.lastLog = 'Stopped by user';
                    const stEl = document.getElementById(`status-${id}`);
                    if (stEl) { stEl.textContent = 'Stopped'; stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-slate-700 text-slate-400 border border-slate-600 mb-1"; }
                    document.getElementById(`stop-${id}`).classList.add('hidden');
                }
            } catch (e) { }
        }
    </script>
    <script>
        // ... (pollJobStatus, restoreSession, pollLogs remain essentially the same, just ensuring no loose alerts)
        async function pollJobStatus(job) {
            const sid = job.id;
            let lastLogCount = 0;
            const poll = async () => {
                if (job.status !== 'Running' && job.status !== 'Restoring') return;
                try {
                    const res = await fetch(`/api/status/${sid}`);
                    const st = await res.json();

                    const logRes = await fetch(`/api/logs/${sid}`);
                    if (logRes.ok) {
                        const logs = await logRes.json();
                        if (logs.length > lastLogCount) {
                            const newLogs = logs.slice(lastLogCount);
                            newLogs.forEach(l => {
                                job.lastLog = l.message;
                                job.fullLogs.push({ msg: l.message, isError: l.is_error });
                            });
                            lastLogCount = logs.length;

                            const logEl = document.getElementById(`lastlog-${job.id}`);
                            if (logEl) logEl.textContent = job.lastLog;
                            const lastProg = logs[logs.length - 1].progress;
                            if (lastProg !== undefined) {
                                job.progress = lastProg;
                                const progEl = document.getElementById(`prog-${job.id}`);
                                if (progEl) progEl.style.width = lastProg + '%';
                            }
                        }
                    }

                    if (!st.active) {
                        job.status = 'Done';
                        const hasError = job.fullLogs.some(l => l.isError && l.msg.includes('Critical'));
                        if (hasError) job.status = 'Error';

                        const stEl = document.getElementById(`status-${job.id}`);
                        if (stEl) {
                            stEl.textContent = job.status;
                            // Dark Mode Badges
                            if (job.status === 'Error') stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-red-900/30 text-red-400 border border-red-500/30 mb-1";
                            else stEl.className = "inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-emerald-900/30 text-emerald-400 border border-emerald-500/30 mb-1";
                        }
                        // document.getElementById(`stop-${job.id}`).classList.add('hidden');
                        saveBatchState();
                        return; // End poll
                    }
                    setTimeout(poll, 3000);
                } catch (e) { setTimeout(poll, 5000); }
            };
            poll();
        }

        // --- SESSION RECOVERY ---
        async function restoreSession() {
            // 1. Check Single Sync (Legacy)
            const sid = localStorage.getItem('active_sync_id');
            if (sid) {
                // Try restore single sync logic
                try {
                    const res = await fetch(`/api/status/${sid}`);
                    const status = await res.json();
                    if (status.active) {
                        // Restore UI for Single Sync
                        const config = JSON.parse(localStorage.getItem('active_sync_config') || '{}');
                        if (config.src_host) document.getElementById('src_host').value = config.src_host;
                        if (config.dest_host) document.getElementById('dest_host').value = config.dest_host;
                        currentSyncId = sid;

                        // Enable Single Tab
                        switchTab('single');
                        startBtn.disabled = true; startBtn.style.opacity = '0.5';
                        stopBtn.classList.remove('hidden');
                        logsDiv.innerHTML = '';
                        appendLog(">>> Restoring session connection...", false);
                        pollLogs(sid);
                    } else { localStorage.removeItem('active_sync_id'); }
                } catch (e) { }
            }

            // 2. Check Bulk Sync
            const savedBatch = localStorage.getItem('active_batch_jobs');
            if (savedBatch) {
                try {
                    bulkJobs = JSON.parse(savedBatch);
                    if (bulkJobs.length > 0) {
                        switchTab('bulk');
                        renderJobs();
                        document.getElementById('jobsContainer').classList.remove('hidden');
                        document.getElementById('jobsPlaceholder').classList.add('hidden');

                        // Assume running/paused if saved
                        if (localStorage.getItem('is_batch_running') === 'true') {
                            document.getElementById('btnStartBatch').disabled = true;
                            document.getElementById('btnStopBatch').classList.remove('hidden');
                            isBatchRunning = true;
                        }

                        let runningCount = 0;
                        bulkJobs.forEach(job => {
                            if (job.status === 'Running') {
                                job.status = 'Restoring';
                                pollJobStatus(job);
                                runningCount++;
                            }
                        });

                        // Restart worker if needed (pending jobs exist)
                        const hasPending = bulkJobs.some(j => j.status === 'Pending');
                        if (hasPending && isBatchRunning) {
                            isBatchRunning = false;
                            startBatch();
                        } else if (runningCount === 0 && !hasPending) {
                            cleanupBatch();
                        }
                    }
                } catch (e) { console.error("Batch restore error", e); }
            }
        }

        async function pollLogs(sid) {
            let lastLogCount = 0;
            const poll = async () => {
                if (!currentSyncId) return; // Stopped
                try {
                    const res = await fetch(`/api/status/${sid}`);
                    const st = await res.json();

                    const logRes = await fetch(`/api/logs/${sid}`);
                    if (logRes.ok) {
                        const logs = await logRes.json();
                        // Append new logs
                        if (logs.length > lastLogCount) {
                            const newLogs = logs.slice(lastLogCount);
                            newLogs.forEach(l => appendLog(l.message, l.is_error || l.i_error));
                            lastLogCount = logs.length;
                        }
                    }

                    if (!st.active) {
                        // Done
                        startBtn.disabled = false; startBtn.style.opacity = '1';
                        stopBtn.classList.add('hidden');
                        appendLog(">>> Process finished.", false);
                        localStorage.removeItem('active_sync_id');
                        currentSyncId = null;
                        return;
                    }

                    setTimeout(poll, 2000);
                } catch (e) { setTimeout(poll, 5000); }
            };
            poll();
        }

        // Init
        restoreSession();
    </script>

    <!-- GUIDE MODAL (VIETNAMESE) -->
    <div id="guideModal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeGuide()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div
                class="bg-slate-800 rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden border border-slate-600 fade-in ring-1 ring-white/10">
                <div class="px-6 py-4 border-b border-slate-600 flex justify-between items-center bg-slate-900/50">
                    <div class="flex items-center gap-2">
                        <span class="bg-blue-500/10 text-blue-400 p-1.5 rounded-lg border border-blue-500/20">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                        </span>
                        <h3 class="font-bold text-slate-200 text-lg">HÆ°á»›ng Dáº«n Sá»­ Dá»¥ng (User Guide)</h3>
                    </div>
                    <button onclick="closeGuide()"
                        class="text-slate-500 hover:text-white transition-colors bg-slate-700/50 hover:bg-slate-700 rounded-lg p-1">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-0 text-sm text-slate-300">
                    <div class="grid grid-cols-1 md:grid-cols-3 min-h-full">
                        <!-- Sidebar -->
                        <div class="bg-slate-900/50 border-r border-slate-600 p-4 space-y-1">
                            <button onclick="scrollToSection('sec-intro')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">1.
                                Giá»›i thiá»‡u chung</button>
                            <button onclick="scrollToSection('sec-single')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">2.
                                Single Sync (ÄÆ¡n)</button>
                            <button onclick="scrollToSection('sec-bulk')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">3.
                                Bulk Sync & CSV</button>
                            <button onclick="scrollToSection('sec-advanced')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">4.
                                Cáº¥u hÃ¬nh nÃ¢ng cao</button>
                            <button onclick="scrollToSection('sec-notes')"
                                class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 text-slate-400 hover:text-white font-medium transition-colors focus:bg-slate-800 focus:text-blue-400">5.
                                LÆ°u Ã½ quan trá»ng</button>
                        </div>

                        <!-- Content -->
                        <div class="col-span-2 p-8 space-y-12 scroll-smooth" id="guideContent">

                            <!-- Intro -->
                            <section id="sec-intro" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm">1</span>
                                    Giá»›i thiá»‡u chung
                                </h4>
                                <p class="leading-relaxed text-slate-400">
                                    **IMAP Sync Pro** lÃ  cÃ´ng cá»¥ há»— trá»£ chuyá»ƒn dá»¯ liá»‡u email (migration) tá»« server
                                    nÃ y
                                    sang server khÃ¡c thÃ´ng qua giao thá»©c IMAP.
                                    CÃ´ng cá»¥ há»— trá»£ cháº¡y cháº¡y ná»n vá»›i hiá»‡u suáº¥t cao, tá»± Ä‘á»™ng khÃ´i phá»¥c tiáº¿n trÃ¬nh náº¿u
                                    trÃ¬nh duyá»‡t bá»‹ táº£i láº¡i, vÃ  cung cáº¥p bÃ¡o cÃ¡o chi tiáº¿t.
                                </p>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Single Sync -->
                            <section id="sec-single" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center text-sm">2</span>
                                    Single Sync (Cháº¡y Ä‘Æ¡n láº»)
                                </h4>
                                <div class="space-y-3 text-slate-400 leading-relaxed">
                                    <p>Cháº¿ Ä‘á»™ nÃ y dÃ¹ng Ä‘á»ƒ test hoáº·c cháº¡y chuyá»ƒn Ä‘á»•i cho **1 tÃ i khoáº£n duy nháº¥t**.
                                    </p>
                                    <ul class="list-disc pl-5 space-y-2">
                                        <li><strong class="text-slate-200">Source (Nguá»“n):</strong> Nháº­p thÃ´ng tin
                                            server cÅ© (Host, Email, Password). Port máº·c Ä‘á»‹nh lÃ  993 (SSL).</li>
                                        <li><strong class="text-slate-200">Destination (ÄÃ­ch):</strong> Nháº­p thÃ´ng
                                            tin
                                            server má»›i.</li>
                                        <li>Báº¥m <strong>"Start Migration"</strong> Ä‘á»ƒ báº¯t Ä‘áº§u. Log chi tiáº¿t sáº½ hiá»‡n
                                            á»Ÿ
                                            cá»™t bÃªn pháº£i.</li>
                                    </ul>
                                </div>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Bulk Sync -->
                            <section id="sec-bulk" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center text-sm">3</span>
                                    Bulk Sync (Cháº¡y hÃ ng loáº¡t)
                                </h4>
                                <div class="space-y-4 text-slate-400 leading-relaxed">
                                    <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                                        <h5 class="font-bold text-slate-200 mb-2">Äá»‹nh dáº¡ng file CSV</h5>
                                        <p class="mb-2">Báº¡n cÃ³ thá»ƒ nháº­p trá»±c tiáº¿p hoáº·c upload file `.csv` khÃ´ng cÃ³
                                            tiÃªu
                                            Ä‘á» (header). Má»—i dÃ²ng lÃ  má»™t tÃ i khoáº£n.</p>

                                        <div class="grid gap-4 mt-3">
                                            <div>
                                                <div class="text-xs font-bold text-blue-400 uppercase mb-1">Dáº¡ng 1:
                                                    ÄÆ¡n
                                                    giáº£n (DÃ¹ng chung Host)</div>
                                                <code
                                                    class="block bg-slate-950 p-3 rounded-lg font-mono text-xs text-emerald-400 break-all">user1,pass1,user1_new,pass2<br>user2,pass3,user2_new,pass4</code>
                                                <p class="text-xs mt-1 italic">Há»‡ thá»‘ng sáº½ dÃ¹ng Host máº·c Ä‘á»‹nh báº¡n
                                                    Ä‘iá»n á»Ÿ
                                                    trÃªn.</p>
                                            </div>
                                            <div>
                                                <div class="text-xs font-bold text-indigo-400 uppercase mb-1">Dáº¡ng
                                                    2:
                                                    Chi tiáº¿t (8 trÆ°á»ng)</div>
                                                <code
                                                    class="block bg-slate-950 p-3 rounded-lg font-mono text-xs text-yellow-500 break-all">src_host,993,src_user,pass,dest_host,993,dest_user,pass</code>
                                            </div>
                                        </div>
                                    </div>
                                    <p>
                                        Sau khi nháº­p liá»‡u, báº¥m <strong>Review Jobs</strong> Ä‘á»ƒ lÃªn danh sÃ¡ch chá».
                                        Báº¥m
                                        <strong>Start Batch</strong> Ä‘á»ƒ cháº¡y.
                                        Báº¡n cÃ³ thá»ƒ chá»‰nh sá»‘ luá»“ng (Concurrency) Ä‘á»ƒ cháº¡y song song nhiá»u tÃ i khoáº£n
                                        cÃ¹ng
                                        lÃºc.
                                    </p>
                                </div>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Advanced -->
                            <section id="sec-advanced" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center text-sm">4</span>
                                    Cáº¥u hÃ¬nh nÃ¢ng cao
                                </h4>
                                <ul class="list-disc pl-5 space-y-2 text-slate-400 leading-relaxed">
                                    <li><strong class="text-slate-200">Dry Run:</strong> Cháº¡y mÃ´ phá»ng, khÃ´ng copy
                                        dá»¯
                                        liá»‡u tháº­t, dÃ¹ng Ä‘á»ƒ kiá»ƒm tra káº¿t ná»‘i Ä‘Äƒng nháº­p.</li>
                                    <li><strong class="text-slate-200">Sync from Date:</strong> Chá»‰ copy email tá»«
                                        ngÃ y
                                        nÃ y trá»Ÿ Ä‘i.</li>
                                    <li><strong class="text-slate-200">Exclude Folders:</strong> Bá» qua cÃ¡c thÆ° má»¥c
                                        khÃ´ng cáº§n thiáº¿t (VD: Trash, Spam, Junk). CÃ¡ch nhau báº±ng dáº¥u pháº©y.</li>
                                    <li><strong class="text-slate-200">Smart Map (Auto):</strong> Tá»± Ä‘á»™ng nháº­n diá»‡n
                                        vÃ 
                                        ghÃ©p cáº·p cÃ¡c thÆ° má»¥c Ä‘áº·c biá»‡t (Sent, Trash, Spam) giá»¯a 2 server khÃ¡c loáº¡i.
                                    </li>
                                    <li>
                                        <strong class="text-slate-200">Folder Mapping (Manual):</strong> Chuyá»ƒn Ä‘á»•i
                                        tÃªn
                                        thÆ° má»¥c thá»§ cÃ´ng.
                                        <div
                                            class="mt-1 bg-slate-900/50 p-2 rounded-lg border border-slate-700 text-xs font-mono text-emerald-400">
                                            Sent Messages:Sent Items<br>Drafts:Drafts New
                                        </div>
                                    </li>
                                </ul>
                            </section>

                            <hr class="border-slate-700/50">

                            <!-- Notes -->
                            <section id="sec-notes" class="space-y-4">
                                <h4 class="text-xl font-bold text-white flex items-center gap-2">
                                    <span
                                        class="w-8 h-8 rounded-full bg-red-600 text-white flex items-center justify-center text-sm">5</span>
                                    LÆ°u Ã½ quan trá»ng
                                </h4>
                                <div
                                    class="bg-red-500/10 border border-red-500/20 p-4 rounded-xl text-red-200 text-sm space-y-2">
                                    <p>âš ï¸ <strong>Gmail:</strong> Pháº£i báº­t "2-Step Verification" vÃ  táº¡o <strong>App
                                            Password</strong> thÃ¬ má»›i káº¿t ná»‘i Ä‘Æ°á»£c. Máº­t kháº©u Ä‘Äƒng nháº­p thÆ°á»ng sáº½
                                        khÃ´ng
                                        hoáº¡t Ä‘á»™ng.</p>
                                    <p>âš ï¸ <strong>Outlook/Office365:</strong> Má»™t sá»‘ tá»• chá»©c cháº·n IMAP, cáº§n liÃªn há»‡
                                        admin Ä‘á»ƒ báº­t.</p>
                                    <p>âš ï¸ <strong>KhÃ´ng Ä‘Ã³ng tab trÃ¬nh duyá»‡t:</strong> Máº·c dÃ¹ há»‡ thá»‘ng cÃ³ cÆ¡ cháº¿
                                        khÃ´i
                                        phá»¥c, nhÆ°ng Ä‘á»ƒ á»•n Ä‘á»‹nh nháº¥t, hÃ£y giá»¯ tab trÃ¬nh duyá»‡t má»Ÿ khi Ä‘ang cháº¡y Batch
                                        lá»›n.
                                    </p>
                                </div>
                            </section>

                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 border-t border-slate-600 bg-slate-900/50 flex justify-end">
                    <button onclick="closeGuide()"
                        class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 transition-all text-sm">ÄÃ£
                        hiá»ƒu / Got it</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showGuide() {
            document.getElementById('guideModal').classList.remove('hidden');
        }
        function closeGuide() {
            document.getElementById('guideModal').classList.add('hidden');
        }
        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>

</html>